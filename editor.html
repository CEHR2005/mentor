<!DOCTYPE html>
<html class="mentor" lang="ru">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta http-equiv="cache-control" content="max-age=0"/>
<meta http-equiv="cache-control" content="no-cache"/>
<meta http-equiv="expires" content="0"/>
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT"/>
<meta http-equiv="pragma" content="no-cache"/>

<link rel="icon" type="image/png" href="img/favicon.png?d" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta property="og:type" content="website">
<meta property="og:site_name" content="GURPS Mentor">
<meta property="og:title" content="GURPS Mentor">
<meta property="og:description" content="Онлайн редактор персонажей для GURPS на русском языке">
<meta property="og:image" content="http://mentor.gurps.ru/img/socail.png">

<title>GURPS Mentor</title>

<script type="text/javascript" src="js/jquery-latest.min.js"></script>
<script type="text/javascript" src="js/jquery-ui.min.js"></script>
<script type="text/javascript" src="js/jquery.scrollTo.min.js"></script>

<script type="text/javascript" src="js/pasteimage.js"></script>

<script src="js/jquery.cookie.js" type="text/javascript"></script>

<script src="js/html.sortable.js" type="text/javascript"></script><!--from https://github.com/lukasoppermann/html5sortable-->
<script src="js/size-limited-stack-master.js" type="text/javascript"></script><!--from https://github.com/Tyriar/size-limited-stack-->

<script src="constants.js?rnd==6.0-donats-31" type="text/javascript"></script>
<script src="functions.js?rnd==6.0-donats-31" type="text/javascript"></script>

<script>
  var mentorVersion='6.0-donats-31';
</script>

<link rel="stylesheet" type="text/css" href="style-dark-compressed.css?rnd=6.0-donats-31" disabled class="dark-theme"/>
<link rel="stylesheet" type="text/css" href="style-compressed.css?rnd=6.0-donats-31" class="light-theme"/>
<script>  setMentorTheme();</script>

</head>

<div id="wrong-browser"
     style="background:#f58800; color:#fff;  position: absolute; top:0; left:0; width:100%; z-index: 1000; padding:20px; display: none;">
  <div style="margin:0 auto; max-width:600px;">
    <i class="fa fa-times-circle" style="float:right; cursor:pointer;" onClick="$('#wrong-browser').fadeOut(300);"></i>
    <h2>Видимо ваш браузер не Chrome :(</h2>
    <p>К сожалению автор ведет разработку в одиночку и в данный момент не может поддерживать разные браузеры.</p>
    <p>С очень большой вероятностью в других браузерах возникнет масса проблем вплоть до повреждения сохраненного
      персонажа - пожалуйста, если Вам нравится GURPS Mentor - используйте <a href="https://www.google.com/chrome/" style="color:#fff;">Chrome</a>
    </p>
  </div>
</div>
<script>

//  if (navigator.userAgent.search("Chrome")==-1) {
//  if (!window.chrome) {
//  if (!window.webkitURL) {
 if (navigator.userAgent.indexOf("Chrome") == -1) {

    $("#wrong-browser").show();
  }
</script>
<constants style="display: none;"><hints>
  <st_result>
    <span style='float:right'>B14</span>
    <h4>Сила | ST | СЛ</h4>
    ±10 очков/уровень<br>
    Сила отражает физическую мощь и крепость. Этот показатель критичен для воина в неразвитом мире, потому что высокая ST позволяет наносить и выдерживать больше повреждений в рукопашной. Любой приключенец знает, что ST полезна, чтобы поднимать и метать предметы, быстро передвигаться с нагрузкой и т. д. ST непосредственно определяет Базовый подъем (B15), базовые повреждения (B15) и Хиты (B16), а также влияет на Телосложение (B18) персонажа.<br>
    Грузоподъемность пропорциональна квадрату вашей ST. В сравнении со средним взрослым человеком (ST10 - 10x10=100), человек с ST 14 почти в два раза сильнее (14x14=196), с ST 17 - в три раза (17x17=289), с ST 20 - в четыре раза сильнее (20x20=400=4x100). Аналогично, при ST 7 вы слабее примерно вполовину (7x7=49), при ST 6 примерно в три раза (6x6=36), а при ST 5 в четыре раза (5x5=25=100/4).<br>
    Сила гораздо менее ограничена сверху, чем остальные атрибуты; значения выше 20 часто встречаются среди существ вроде крупных животных, фантастических чудовищ и роботов. Даже человек может обладать ST больше 20 - рекордсмены-тяжелоатлеты могут быть очень сильны!<br>
    Существа, имеющие нечеловеческую физиологию, с разрешения мастера могут приобретать ST с одним или обоими ограничениями, приведенными ниже. Вы не можете снизить стоимость более чем на 80% с помощью ограничений; считайте любое значение сверх -80% за -80%. (Подробнее об ограничениях см. на B110)<br>

    <h4>Особые ограничения</h4>
    Нет тонких манипуляторов: Если у вас имеется какой-либо уровень недостатка Нет тонких манипуляторов (B145), то вы можете приобретать ST дешевле. -40%.<br>
    Размер: Крупные существа могут приобретать ST дешевле; подробности см. на B19. -10% x Модификатор размера; вплоть до максимума -80% (при Модификаторе размера +8 и больше).<br>


    <h4>Как выбирать базовые атрибуты</h4>
    От выбора базовых атрибутов зависят ваши способности - сильные и слабые стороны - в игре. Выбирайте с умом.<br>
    <b>6 и меньше</b>: Калечащий уровень. Столь низкий атрибут серьезно ограничивает ваш образ жизни.<br>
    <b>7</b>: Низкий. Ваши ограничения легко заметны любому, кто вас встречает. Это самое низкое значение, при котором вы еще не становитесь инвалидом.<br>
    <b>8 или 9</b>: Ниже среднего. Это невысокие значения, но все же в пределах человеческой нормы. Мастеру следует запретить активным участникам приключений атрибуты ниже 8.<br>
    <b>10</b>: Средний. У большинства людей уровень 10 и они чувствуют себя прекрасно!<br>
    <b>11 или 12</b>: Выше среднего. Это более высокое значение, но все же в пределах человеческой нормы.<br>
    <b>13 или 14</b>: Выдающийся. Подобный атрибут заметен сразу - в виде вздувшихся мускулов, кошачьей грации, остроумной речи или пышущего здоровья.<br>
    <b>15 и больше</b>: Поразительный. Столь высокий атрибут вызывает постоянные обсуждения и, вероятно, определяет выбор вами карьеры.<br>
    Все описанное выше относится к людям. Для нелюдей считайте каждое очко выше или ниже человеческой нормы 10 отклонением от расовой нормы в десять процентов.
  </st_result>

  <dx_result>
    <span style='float:right'>B14</span>
    <h4>Ловкость | DX | ЛВ</h4>
    ±20 очков/уровень<br>
    Ловкость отражает сочетание подвижности, координации и тонкой моторики. Она отвечает за базовые способности к атлетическим и боевым умениям, к навыкам вождения и ремеслам, требующим тонкой работы. Кроме того, DX помогает определить Базовую скорость (Speed) (она отражает время реакции, B17) и Базовое передвижение (Move) (быстрота бега, B17).<br>
    Существа, имеющие нечеловеческую физиологию, с разрешения мастера могут приобретать DX с ограничениями, приведенными ниже.<br>


    <h4>Как выбирать базовые атрибуты</h4>
    От выбора базовых атрибутов зависят ваши способности - сильные и слабые стороны - в игре. Выбирайте с умом.<br>
    <b>6 и меньше</b>: Калечащий уровень. Столь низкий атрибут серьезно ограничивает ваш образ жизни.<br>
    <b>7</b>: Низкий. Ваши ограничения легко заметны любому, кто вас встречает. Это самое низкое значение, при котором вы еще не становитесь инвалидом.<br>
    <b>8 или 9</b>: Ниже среднего. Это невысокие значения, но все же в пределах человеческой нормы. Мастеру следует запретить активным участникам приключений атрибуты ниже 8.<br>
    <b>10</b>: Средний. У большинства людей уровень 10 и они чувствуют себя прекрасно!<br>
    <b>11 или 12</b>: Выше среднего. Это более высокое значение, но все же в пределах человеческой нормы.<br>
    <b>13 или 14</b>: Выдающийся. Подобный атрибут заметен сразу - в виде вздувшихся мускулов, кошачьей грации, остроумной речи или пышущего здоровья.<br>
    <b>15 и больше</b>: Поразительный. Столь высокий атрибут вызывает постоянные обсуждения и, вероятно, определяет выбор вами карьеры.<br>
    Все описанное выше относится к людям. Для нелюдей считайте каждое очко выше или ниже человеческой нормы 10 отклонением от расовой нормы в десять процентов.
  </dx_result>

  <iq_result>
    <span style='float:right'>B15</span>
    <h4>Интеллект | IQ | ИН</h4>
    ±20 очков/уровень<br>
    Интеллект в широком смысле отражает интеллектуальный потенциал, включая творчество, интуицию, память, восприятие, ум, здравомыслие и силу воли. Он отвечает за базовые способности во всех "ментальных" умениях - науках, социальном взаимодействии, магии и т. д. Любой волшебнику, ученому или изобретателю высокий IQ нужен в первую очередь. Вторичные характеристики Воля (Will) (B16) и Восприятие (Per) (B16) основаны на IQ.

    <h4>Как выбирать базовые атрибуты</h4>
    От выбора базовых атрибутов зависят ваши способности - сильные и слабые стороны - в игре. Выбирайте с умом.<br>
    <b>6 и меньше</b>: Калечащий уровень. Столь низкий атрибут серьезно ограничивает ваш образ жизни.<br>
    <b>7</b>: Низкий. Ваши ограничения легко заметны любому, кто вас встречает. Это самое низкое значение, при котором вы еще не становитесь инвалидом.<br>
    <b>8 или 9</b>: Ниже среднего. Это невысокие значения, но все же в пределах человеческой нормы. Мастеру следует запретить активным участникам приключений атрибуты ниже 8.<br>
    <b>10</b>: Средний. У большинства людей уровень 10 и они чувствуют себя прекрасно!<br>
    <b>11 или 12</b>: Выше среднего. Это более высокое значение, но все же в пределах человеческой нормы.<br>
    <b>13 или 14</b>: Выдающийся. Подобный атрибут заметен сразу - в виде вздувшихся мускулов, кошачьей грации, остроумной речи или пышущего здоровья.<br>
    <b>15 и больше</b>: Поразительный. Столь высокий атрибут вызывает постоянные обсуждения и, вероятно, определяет выбор вами карьеры.<br>
    Все описанное выше относится к людям. Для нелюдей считайте каждое очко выше или ниже человеческой нормы 10 отклонением от расовой нормы в десять процентов.
  </iq_result>

  <ht_result>
    <span style='float:right'>B15</span>
    <h4>Здоровье | HT | ЗД</h4>
    ±10 очков/уровень<br>
    Здоровье отражает энергию и жизнестойкость. В него входят выносливость, сопротивляемость организма (ядам, болезням, радиации и т. д.) и общая "твердость". Высокий уровень HT пригодится любому - но он жизненно необходим бойцам в мире низких технологий. HT определяет запас Усталости (FP) (B16), помогает определить Базовую скорость (Speed) (B17) и Базовое передвижение (Move) (B17).

    <h4>Как выбирать базовые атрибуты</h4>
    От выбора базовых атрибутов зависят ваши способности - сильные и слабые стороны - в игре. Выбирайте с умом.<br>
    <b>6 и меньше</b>: Калечащий уровень. Столь низкий атрибут серьезно ограничивает ваш образ жизни.<br>
    <b>7</b>: Низкий. Ваши ограничения легко заметны любому, кто вас встречает. Это самое низкое значение, при котором вы еще не становитесь инвалидом.<br>
    <b>8 или 9</b>: Ниже среднего. Это невысокие значения, но все же в пределах человеческой нормы. Мастеру следует запретить активным участникам приключений атрибуты ниже 8.<br>
    <b>10</b>: Средний. У большинства людей уровень 10 и они чувствуют себя прекрасно!<br>
    <b>11 или 12</b>: Выше среднего. Это более высокое значение, но все же в пределах человеческой нормы.<br>
    <b>13 или 14</b>: Выдающийся. Подобный атрибут заметен сразу - в виде вздувшихся мускулов, кошачьей грации, остроумной речи или пышущего здоровья.<br>
    <b>15 и больше</b>: Поразительный. Столь высокий атрибут вызывает постоянные обсуждения и, вероятно, определяет выбор вами карьеры.<br>
    Все описанное выше относится к людям. Для нелюдей считайте каждое очко выше или ниже человеческой нормы 10 отклонением от расовой нормы в десять процентов.
  </ht_result>

  <hp_result>
    <span style='float:right'>B15</span>
    <h4>Жизни | HP | ОЗ</h4>
    ±2 очков за ±1 HP<br>
    HP отражают способность вашего тела выдерживать повреждения. По умолчанию число хитов равняется вашей ST. Например, ST 10 даст 10 HP.<br>
    Вы можете повысить число HP по цене 2 очка за хит или снизить его по -2 очка за хит. В реалистичной кампании мастер не должен позволять колебания HP в пределах более чем ±30% от значения ST; например, персонаж с ST 10 может иметь от 7 до 13 хитов. Нелюди и супергерои не подвержены этому ограничению.<br>
    Вы можете временно терять HP под воздействием физических (удар мечом), энергетических (попадание из лазера) и сверхъестественных атак, болезней, ядов, несчастных случаев и всего прочего, что может нанести повреждения или убить. Кроме того, вы можете тратить хиты для подпитки своих сверхъестественных способностей. Если вы потеряли достаточно HP, то в конечном счете окажетесь без сознания; потеряв слишком много хитов, вы умрете. Потерянные хиты не снижают ST, хотя число HP и зависит от Силы.<br>
    Ранения часто сравниваются с числами, кратными HP; например "2xHP" или "HP/2". В таких формулах отталкивайтесь от своего базового значения HP, а не количества хитов в данный момент.<br>
    Описание эффектов ранений и восстановления потерянных HP см. на B418-B425.<br>
    Существа, имеющие нечеловеческую физиологию, с разрешения мастера могут приобретать дополнительные HP с ограничениями, указанными ниже.<br>

    <h4>Особые ограничения</h4>
    Размер: Крупные существа могут приобретать HP дешевле; подробности см. на B19. -10% x Модификатор размера; вплоть до максимума -80% (при Модификаторе размера +8 и больше).
  </hp_result>

  <move_result>
    <span style='float:right'>B17</span>
    <h4>Базовое движение | Move | БД</h4>
    ±5 очков за ±1 ярд/сек.<br>
    Базовое движение отражает скорость передвижения по земле в ярдах в секунду. То, насколько быстро вы можете бежать - или катиться, скользить и т. д. - без нагрузки (хотя вы можете двигаться и немного быстрее во время "спринтерского бега" по прямой; см. B354).<br>
    Базовое передвижение по умолчанию равно Базовой скорости без учета дробной части; например, Базовая скорость 5.75 дает Базовое передвижение 5. Базовое передвижение среднего человека составляет 5; таким образом, без нагрузки он может бежать со скоростью около 5 ярдов в секунду.<br>
    Вы можете повышать Базовое передвижение по цене 5 очков за +1 ярд в секунду или снижать ее по -5 очков за -1 ярд в секунду. У обычных людей тренировки или хорошее сложение могут оправдать увеличение Базового передвижения на число до 3 ярдов/сек., а травма или неспортивное сложение - снижение Базового передвижения на 3 ярда/сек. Нелюди и супергерои не подвержены этому ограничению. Расам и супергероям, способным двигаться очень быстро, следует взять Увеличенное передвижение (B52).<br>
    Ваше Передвижение в бою равняется Базовому передвижению с изменениями за уровень нагрузки; см. Нагрузка и передвижение (ниже).<br>

    <h4>Нагрузка и передвижение</h4>
    Нагрузка отражает общий вес того, что вы поднимаете, относительно вашей ST. Эффекты, вызываемые Нагрузкой, разделены на пять "уровней нагрузки". Все кроме самого низкого из них снижают ваше Передвижение до части Базового и дают пенальти к Уклонению следующим образом:<br>
    <br>
    <b>Нет нагрузки (0)</b>: Вес не превышающий вашего Базового подъема. Передвижение = Базовое передвижение. Полное уклонение.<br>
    <b>Легкая нагрузка (1)</b>: Вес до 2xBL. Передвижение = Базовое передвижение x 0.8. Уклонение -1.<br>
    <b>Средняя нагрузка (2)</b>: Вес до 3xBL. Передвижение = Базовое передвижение x 0.6. Уклонение -2.<br>
    <b>Тяжелая нагрузка (3)</b>: Вес до 6xBL. Передвижение = Базовое передвижение x 0.4. Уклонение -3.<br>
    <b>Сверх-тяжелая нагрузка (4)</b>: Вес до 10xBL. Передвижение = Базовое передвижение x 0.2. Уклонение -4.<br>
    <br>
    Все дробные части отбрасываются. Нагрузка не может снижать Передвижение или Уклонение ниже 1.<br>
    Обратите внимание, что эти уровни помечены числами от 0  до 4. Когда правило велит добавить к броску (или вычесть из него) уровень нагрузки, то используется это число. Так, нагрузка  дает пенальти к проверкам Лазания, Скрытности и Плавания.<br>
  </move_result>

  <speed_result>
    <span style='float:right'>B17</span>
    <h4>Базовая скорость | Basic Speed | БС</h4>
    ±5 очков за ±0.25 к Скорости<br>

    Базовая скорость отражает ваши рефлексы и общую быстроту тела. Она помогает определить скорость бега (см. Базовое передвижение ниже), вероятность уклониться от удара и вашу очередность в бою (высокая Базовая скорость позволит вам опередить противников).<br>
    Чтобы вычислить Базовую скорость, сложите свои показатели HT и DX, а затем разделите сумму на 4. Не округляйте результат. 5.25 лучше чем 5!<br>
    Вы можете повышать Базовую скорость по цене 5 очков за +0.25 или снижать ее по -5 очков за -0.25. В реалистичной кампании мастер не должен позволять персонажам изменять Базовую скорость более чем на 2.00 в любую сторону. Нелюди и супергерои не подвержены этому ограничению.<br>

    <b>Уклонение</b>: Ваша защита Уклонением (см. Уклонение, B374) равняется Базовой скорости +3, без учета дробной части. Например, если ваша Базовая скорость составляет 5.25, то ваше Уклонение равняется 8. Нагрузка снижает Уклонение; см. Нагрузка и передвижение (ниже). Вы должны выбросить на 3d число, не превышающее значение Уклонения, чтобы увернуться или отойти в сторону, избежав атаки.<br>
  </speed_result>

  <will_result>
    <span style='float:right'>B16</span>
    <h4>Воля  | Will </h4>
    ±5 очков за ±1 Воли<br>
    Воля отражает вашу способность выдерживать психологическое давление (идеологическую обработку, страх, гипноз, допросы, соблазнение, пытки и т. д.), а также вашу сопротивляемость атакам сверхъестественного характера (магия, псионика и т. д.). По умолчанию Воля равняется вашему IQ. Вы можете повысить ее по цене 5 очков за +1 или снизить по -5 очков за -1. Вы не можете поднимать Волю выше 20 или снижать ниже 4 без согласования с мастером.<br>
    Обратите внимание, что Воля не отражает физическую сопротивляемость - за нее отвечает HT!<br>
  </will_result>

  <perception_result>
    <span style='float:right'>B16</span>
    <h4>Восприятие  | Per | Восп</h4>
    ±5 очков за ±1 Восприятия<br>
    Восприятие отражает вашу общую бдительность. Мастер проводит "Проверки чувств" против вашего Восприятия, чтобы определить, смогли ли вы что-либо заметить (см. Проверки чувств, B358). По умолчанию Восприятие равняется вашему IQ, но вы можете повысить его по цене 5 очков за +1 или снизить по -5 очков за -1. Вы не можете поднимать Восприятие выше 20 или снижать ниже 4 без согласования с мастером.
  </perception_result>

  <fp_result>
    <span style='float:right'>B16</span>
    <h4>Единицы усталости | FP | ЕУ</h4>
    ±3 очков за ±1 FP<br>
    Очки усталости отражают "энергетический запас" вашего тела. По умолчанию число FP равняется вашему HT. Например, HT 10 даст 10 FP.<br>
    Вы можете повысить FP по цене 3 очка за FP или снизить их по -3 очка за FP. В реалистичной кампании мастер не должен позволять колебания FP в пределах более чем ±30% от значения HT; например, персонаж с HT 10 может иметь от 7 до 13 очков усталости. Нелюди и супергерои не подвержены этому ограничению. Кроме того, хотя HT обычно ограничено числом 20, для FP не существует подобных ограничений.<br>
    Вы постепенно тратите FP, выполняя действия, требующие усилий. Болезни, жара, голод, недостаток сна и другие подобные вещи также могут ослабить вас. Вы можете сознательно тратить FP на совершение сверх-усилия (см. B356) и подпитку сверхъестественных сил (например, на заклинания). Помимо этого, некоторые атаки наносят вред FP, а не HP, либо и тому и другому. Если вы теряете достаточное число FP, то станете двигаться медленнее или потеряете сознание - а если вы потеряли слишком много сил, то можете умереть от перенапряжения! Потерянные силы не снижают HT, хотя число FP и зависит от здоровья.<br>
    Усталость часто сравнивается с числами, кратными FP; например "2xFP" или "FP/2". В таких формулах отталкивайтесь от своего базового значения FP, а не количества очков усталости в данный момент.<br>
    Подробнее о потере и восстановлении FP см. на B426-B428.<br>
  </fp_result>

  <sm_result>
    <span style='float:right'>B19</span>
    <h4>Модификатор размера| Size Modificator | МР | SM</h4>
    Модификатор размера отражает наиболее крупное измерение существа или предмета: длину, ширину или высоту. Этот модификатор используется при проверках на попадание по вам в бою и проверках Зрения, чтобы увидеть вас. Таким образом, это бонус для крупных существ и пенальти для мелких. Хотя по крупным существам легче попасть, положительный SM позволяет им покупать ST и HT по меньшей цене, беря ограничение за "Размер".<br>
    Большинство людей - а также гуманоидов, роботов и т. п. существ, способных сойти за людей - имеют SM 0 и могут не обращать внимания на это правило. Нелюди используют модификатор из расового шаблона. Однако SM может отличаться от среднего для данной расы, если вы еще слишком молоды, либо являетесь генетическим карликом либо гигантом.<br>
    Создавая существо, по размерам крупнее или меньше человека, найдите его SM исходя из его наибольшего измерения - высоты для прямоходящих существ вроде великанов, длины для горизонтальных - вроде кошек и драконов, диаметра для шарообразных - см. Таблицу модификаторов размера (B19).<br>
    Если набольшее измерение для существа оказывается между двумя значениями таблицы, то брать следует SM от наибольшего. Кубические, шарообразные и бесформенные существа дополнительно получают +2 к SM; вытянутые прямоугольники, вроде большинства видов наземного транспорта, дополнительно получают +1.<br>
    Отличный от нуля Модификатор размера - это не преимущество и не недостаток - плюсы и минусы примерно одинаковы. Исключение составляют заложенные на генетическом уровне карликовость и гигантизм, поскольку они влияют на пропорции тела (особенно на относительную длину рук и ног) и социальные отличия (вы выделяетесь из толпы).<br>
    <br>
    <b>Size Modificator</b><br>-10 5см<br> -9 7см<br> -8 10см<br> -7 15см<br> -6 20см<br> -5 30см<br> -4 0.5м<br> -3 0.7м<br> -2 1м<br> -1 1.5м<br>  0 2м<br> +1 3м<br> +2 5м<br> +3 7м<br> +4 10м<br> +5 15м<br> +6 20м<br> +7 30м<br> +8 50м<br> +9 70м<br>+10 100м<br>+11 150м<br>
  </sm_result>

  <tech_level>
    <span style='float:right'>B511</span>
    <h4>Технические уровни | TL | ТУ</h4>
    Технический уровень - это общее описание высочайших достижений технологии (или определенной области науки). Технологические уровни нумеруются, начиная с нуля и выше.<br>
    Каждый ТУ описывает комплекс технологий, которые становятся доступны с определенного времени. В отношении истории Земли стандартные ТУ следующие:<br>
    <br>
    <b>TL0</b> –  Каменный век (доисторический период). Счет; язык.<br>
    <b>TL1</b> –  Бронзовый век (3500 до н.э.+). Арифметика; письменность.<br>
    <b>TL2</b> –  Железный век (1200 до н.э.+). Геометрия; свитки.<br>
    <b>TL3</b> – Средневековье (600 н.э.+). Алгебра; книги.<br>
    <b>TL4</b> – Век парусов (1450+). Сложные вычисления; переносные печатные устройства.<br>
    <b>TL5</b> –  Индустриальная революция (1730+). Механические вычислительные машины; телеграф.<br>
    <b>TL6</b> –  Век механизации (1880+). Электронные калькуляторы, телефон и радио.<br>
    <b>TL7</b> –  Ядерный век (1940+). Большие компьютеры; телевидение.<br>
    <b>TL8</b> –  Цифровой век (1980+). Персональные компьютеры; глобальные сети.<br>
    <b>TL9</b> –  Век микротехнологий (2025+?). Искусственный интеллект; виртуальная реальность.<br>
    <b>TL10</b> –  Век роботизации (2070+?). Нанотехнологии или другие научные открытия стирают все границы…<br>
    <b>TL11</b> – Век экзотической материи.<br>
    <b>TL12</b> – Все, что захочется Мастеру!<br>
  </tech_level>

  <total_points>
    <span style='float:right'>B10</span>
    <h4>Очки персонажа</h4>
    Очки персонажа - это "валюта", на которую персонаж создается. Все, что улучшает ваши способности, забирает очки персонажа: чтобы добавить способность в лист своего персонажа и использовать ее в игре, вы должны потратить количество очков, равное указанной цене. Все, что снижает ваш потенциал, имеет отрицательную стоимость - то есть возвращает вам некоторое количество очков. Например, если вы начинаете со 125 очков, покупаете преимуществ на 75  очков и недостатков на -15 очков, то получаете в остатке 125 - 75 + 15 = 65 очков.<br>
    <br>
    <h4>Начальное количество очков</h4>
    Мастер определяет, с каким количеством очков начинают персонажи игроков (ИП [PC - player characters]) - герои игры. Это число зависит от того, насколько сильными мастер хочет их видеть, и может находиться в диапазоне от 25 и меньше (маленькие дети) до 1,000 и больше (богоподобные создания) очков, а средним для успешных приключенцев числом будет 100-200 очков.<br>
    Стартовое количество очков иногда называют уровнем силы для данной кампании (см. Уровни силы, B487). Это не то же самое, что и "ставки" в данной кампании! Герои со способностями, позволяющими преодолевать даже самые трудные препятствия в веселой кампании по фэнтези, могут столкнуться со смертельной опасностью в приключении в жанре темных ужасов.<br>
    В большинстве кампаний все игровые персонажи начинают на одном уровне силы. Это просто и честно. Однако не все люди в реальной жизни обладают одинаковым потенциалом, и часто в художественных произведениях один герой явно занимает преобладающее место. Если все с этим согласны, то кто-то из игроков может сыграть "главного героя", которому достанется больше очков, чем остальным персонажам - "героям второго плана" на меньшее количество очков.<br>
    <br>
    <h4>Ограничение на недостатки</h4>
    Недостаток - это любое, что обладает отрицательной стоимостью, включая низкие атрибуты, низкий социальный статус и все особые ограничения, описанные в Главе 3. Теоретически вы можете добавлять недостатки до тех пор, пока не получите количества очков, достаточного для покупки всех преимуществ и умений, каких хотите. Но на деле большинство мастеров предпочтет установить ограничение на недостатки, чтобы игра не превратилась в цирк, где проблемы персонажей заставят забыть и о мире, и о приключении, и обо всем прочем, что придумал мастер. Большинству мастеров кажется трудным водить интересную игру, персонажи которой полные инвалиды - то есть грубые одноглазые рецидивисты и алкоголики, боящиеся темноты.<br>
    Лимит недостатков также служит и другой цели: оно ограничивает доступные начинающим персонажам способности, позволяя мастеру установить максимальные возможности персонажей.<br>
    Неплохим приближенным методом будет ограничить недостатки 50% от числа начальных очков - например, это будет -75 очков в игре для 150-очковых персонажей - но это все полностью на усмотрение мастера.<br>
    Однако если мастер требует от всех персонажей обязательно взять определенные недостатки (например, все персонажи - шпионы, и у них есть Служба в пользу своей организации), такие "недостатки кампании" не нужно включать в общий лимит. Не считаются и те недостатки, которые обязательны для вашей расы (входят в ваш "расовый шаблон", см. B260).<br>
    <br>
    <h4>Очки персонажей в игре</h4>
    Число начальных очков персонажа имеет значение только при вступлении его в игру. Немного спустя оно начнет меняться. Иногда мастер будет награждать вас дополнительными очками или даже новыми способностями... но вы также можете и потерять способности. Все это изменит общее количество ваших очков.<br>
    Со временем ваш персонаж будет стоить больше или меньше очков, чем его компаньоны, даже если все начинали с одного числа. Не беспокойтесь по этому поводу! Приучайтесь относиться к общему числу своих очков как к удобному способу определить потенциал персонажа в данный конкретный момент, а не как к способу измерить общий уровень силы в кампании или как к мере значимости среди других игроков и персонажей.<br>
    Подробности о развитии персонажей см. в Главе 9. B290<br>
  </total_points>

  <hp_lost>
    <h4>Общие ранения: потеря очков здоровья</h4>
    Повторные ранения почти любого заставят в конце концов ослабеть и упасть – даже если каждое из них не велико. Нижеследующая таблица предлагает суммарные эффекты низкого или отрицательного уровня здоровья. Все эффекты кумулятивны.<br>
    Осталось меньше 1/3 ваших базовых HP: вы измотаны ранами. Ваши значения Передвижения и Уклонения уменьшаются вдвое (округлять вверх).<br>
    <br>
    <b>0 HP и меньше</b> – вы почти падаете от ран. Кроме вышеуказанного эффекта, в начале вашего следующего хода вы должны сделать бросок HT, с -1 за каждое полное значение HT ниже нуля.<br>
    Провал означает, что вы падаете без сознания (или просто ваша работа приостанавливается, если вы не имеете сознания или жизни); см. Восстановление сознания (B423). Успешный бросок означает, что вы можете свободно действовать, но для продолжения должны кидать HT каждый следующий ход. Исключение: если вы в свой ход выбираете Бездействие, и не предпринимаете никакой активной защиты, то можете оставаться в сознании, не делая бросков. Броски необходимы только в те ходы, когда вы предпринимаете любые манёвры кроме бездействия – включая броски активной защиты.<br>
    <br>
    <b>-1×HP</b> – в дополнение к вышеописанным эффектам, сделайте немедленный бросок HT, или вы умрёте. (Если этот бросок провалится всего на 1 или 2, вы умираете, но ещё живы – см. Смертельные раны, B423). В случае успешного броска вы можете говорить, сражаться и т. д. – как в предыдущем пункте (до тех пор, пока не провалите бросок HT и не потеряете сознание). Повторные броски от смерти делаются каждый раз, когда вы теряете HP достаточно, чтобы опустить их значение до следующего значения, кратного исходным – независимо от того, получили вы их за один удар или несколько. К примеру, если у вас было 11 HP, вы должны будете делать бросок против смерти при достижении -11 HP. Если вы выжили, то новые броски будут делаться на -22 HP, -33 HP, и так далее…<br>
    <br>
    <b>-5×HP</b> – вы немедленно погибаете. Вы потеряли в 6 раз больше HP, чем у вас было! Никто не может пережить столько ран.<br>
    <br>
    <b>-10×HP</b> – Ваше тело полностью уничтожено, если это отвечает типу полученных повреждений – 200 очков повреждения от стрел оставят окровавленное, но узнаваемое тело; 200 очков повреждений от огня – обугленный труп, совершенно неидентифицируемый. Разница имеет значение в сеттингах, где возможно оживление, воскрешение и т. д.!<br>
    <br>
    Подробности читайте в Главе 14. B149<br>
  </hp_lost>

  <fp_lost>
    <h4>Усталость</h4>
    Бег или плавание на длинные дистанции, удушье и многие другие факторы могут стать причиной «усталости»: временного уменьшения единиц усталости. Ваш показатель единиц усталости (FP) изначально равен вашему HT, но вы можете изменить это значение; см. Единицы усталости (B16). Точно также, как ранение отражает физический вред и уменьшает HP, усталость отражает потерю энергии и уменьшает FP. Когда вы теряете FP, делайте записи об этом в вашем листе персонажа .<br>
    <h4>Потеря единиц усталости</h4>
    Список ниже описывает эффекты, возникающие при низких или отрицательных FP. Все эффекты складываются.<br>
    <br>
    <b>Меньше 1/3 FP</b> - вы очень устали. Передвижение, Уклонения и СЛ уменьшаются в два раза (округлять вверх). Это не касается основанных на силе параметров, как HP и повреждения.<br>
    <br>
    <b>0 FP</b> или меньше - вы на грани потери сознания. Если вы будете и дальше уставать, каждая потерянная FP также будет причинять 1 единицу вреда. Усталость от обезвоживания, истощения и т. п. может убить вас – но вы и сами можете уработаться до смерти. Чтобы делать что-то помимо разговора и отдыха нужна проверка на Волю; в бою проверка делается перед каждым манёвром, кроме Бездействия. При успехе вы можете действовать как обычно. Вы можете тратить FP на заклинания и т. д., а если вы тонете, то можете продолжать бороться, но получаете вышеуказанный урон по 1 HP за потерю каждой FP. При провале вы изнемогаете, выходите из строя и не можете ничего делать пока не восстановите FP до положительных. В случае критического провала сделайте немедленный бросок HT. В случае провала, вы страдаете от сердечного приступа – см. Смертельные состояния (B429).<br>
    <br>
    <b>-1×FP</b> - вы падаете без сознания. В бессознательном состоянии вы восстанавливаете FP в таком же темпе, как при отдыхе. Вы приходите в себя при достижении положительных FP. Ваши FP никогда не могут упасть ниже этого уровня. После этой стадии любые затраты FP в полном объеме вычитаются из ваших FP!<br>
  </fp_lost>

  <!-- Generator -->
  <vars>
    <h2>Переменные</h2>
    <u>Это сложная глава если вы не собираетесь делать чего-то сложного, можете пока пропустить ее</u> :)<br>
    <br>
    Переменные нужны для того, чтобы задать одно значение на всю генерацию.<br>
    Присвоение переменной записывается так <b>$var_name="значение переменной"</b>.<br>
    В формате генерации переменная вызывается записью <b>{$var_name}</b><br>
    При присвоении значения переменной вы можете использовать значения контейнеров<br>
    <example>
      $name="{names}"
    </example>
    Формат генерации
    <example>
      Главный герой {$name}.<br>
      Когда {$name} пришел к старухе она окликнула его:<br>
      - Эй {$name}, как твоя фамилия?!<br>
    </example>
    <br><br>
    Можно использовать случайный выбор - в квадратных скобках через запятую.<br>
    <br>
    Продолжим прошлый пример:<br>
    <example>
      $name="{names}"<br>
      $title="[Маркиз,Барон,Граф,Герцог,Князь]"
    </example>
    Формат генерации
    <example>
      Главный герой {$title} {$name}.<br>
      Когда {$title} {$name} пришел к старухе она окликнула его:<br>
      - Эй {$title}, как тебя звать?!<br>
    </example>
    <br><br>
    Также можно задать набор переменных одним случайным блоком, например:<br>
    <example>
      [$sex-text="мужчина" $sex="m",$sex-text="женщина" $sex="w"]
    </example>

    <h2>Настройки</h2>
    Если какой-то из случайных выборов вы хотите дать настраивать пользователю - поставьте его название в скобках перед знаком [<br>
    Если присваиваются несколько переменных будет использоваться текст первой из них
    <example>
      $title="(Титул)[Маркиз,Барон,Граф,Герцог,Князь]"<br>
      (Пол)[$sex-text="мужчина" $sex="m",$sex-text="женщина" $sex="w"]
    </example>

  </vars>

  <format>
    <h2>Форматирование генератора</h2>
    Чтобы использовать случайное значения из списка напишите его {имя} в фигурных скобках<br>
    <br>
    <example>
      {first-names} {second-names}
    </example>
    Этот пример будет брать случайную строку из списка first-names и добавлять случайное из списка second-names<br>
    <br>
    А вот так можно сгенерировать сказочное арабское имя с генеалогией до деда
    <example>
      {arabic-names} Ибн {arabic-names} Ибн {arabic-names}
    </example>
    Потому что каждый раз, когда вы вызываете {arabic-names} выбирается случайная строка из списка.<br>
    Если вам необходимо использовать одно и то же случайно выбранное значение - используйте "Переменные" (см. выше.)<br>
    <br>
    <b>Слияние списков</b><br>
    Вы можете соединить списки в один для случайного выбора с помощью знака +, например:
    <example>
      Вы нашли {items+warrior-items+wizard-items}
    </example>
    Т.е. будет выбрана строка из списка items или warrior-items или wizard-items

    <h2>Быстрые случайные списки</h2>
    Тексты в квадратных скобках перечисленные через запятую выбираются случайно<br>
    <example>
      В одежде преобладают [красные,синие,розовые] оттенки
    </example>
    <br>
    Можно задать вероятность появления текста в скобках
    <example>
      С утра "чудо" распухло и [ужасно](1/3) мешало ходить
    </example>
    Т.е. с вероятностью 1 из 3 появится слово “ужасно”<br>
    <br>
    Может потребоваться повторить некую фразу случайное количество раз
    <example>
      Она очень[ очень](0-5) любила розы
    </example>
    Таким образом дополнительно слово "очень" будет повторено от ноля до пяти раз<br>
    <br>
    Конечно в такие конструкции можно добавлять списки и переменные<br>
    Возьмем пример с арабским именем и запишем его более интересно
    <example>
      {arabic-names}[ Ибн {arabic-names}](1-4)
    </example>
    Так мы получим имена иногда и до прадеда<br>
    <br>

    Или попробуем поработать с вложениями:
    <example>
      {arabic-names}[ [Ибн ,Абу ,Абд ,Аль-]{arabic-names}](1-4)
    </example>
    Да простят меня лингвисты за столько грубую генерацию.

    Чтобы перевести текст на новую строку воспользуйтесь символом {n}
    <example>
      [{n}* {features}](0-3)
    </example>
    Так мы получим до трех особенность в каждой строчке<br>
    <br>
    <br>

    <h2>Переменные</h2>

    Переменные вставляются с помощью записи {$имя_переменной}
    <example>
      {$name}
    </example>
    Более детально читайте в описании переменных.<br>
    <br>
    В качестве сложного примера для собственного изучения:<br>
    Переменные
    <example>
      [$sex-text="мужчины" $sex="m",$sex-text="женщины" $sex="w"]
    </example>
    Формат генерации
    <example>
      Вы нашли у {$sex-text}
      [{n}* {items+items-{$sex}}](1-5)
    </example>
    Для этого у вас должно быть три списка - один общих вещей items, и два items-m и items-w

    <br>
    <br>

    <h2>Префиксы</h2>
    Для включения в список специфических строк можно использовать префиксы<br>
    Это всегда <b>один</b> символ или число в начале строки и двоеточие
    <example>
      Психолог<br>
      w:Медсестра<br>
      m:Шахтёр<br>
    </example>
    При вызове этого списка <b>{prof}</b> в нем будет только одна строка - "психолог". Но при вызове с префиксами <b>{prof:w}</b> или <b>{prof:m}</b> списки буду дополнены соответствующими строками<br>
    Конечно при вызове можно использовать и переменные - <b>{prof:{$sex}}</b><br>

    <br>
    <br>
    <h2>Включение сторонней генерации</h2>
    <example>
     Его звали {d037d1a2773503b521dad57685b12dd4}
    </example>
    В текст будет добавлен результат другого генератора.<br>
    <br>
    <b>Внимание!</b> ссылка должна быть на режим просмотра!<br>
    <br>

    <br>
    <br>

    <h2>Функции</h2>
    <h3>calc()</h3>
    Выбрасывает случайное значение и считает примитивную математику
    <example>
      calc(3d) бросит и сложит 3 кубика d6<br>
      calc(1d20) получите значение от 1 до 20<br>
      calc(1d39) да, любой странный кубик можно<br>
      calc(1d+5) получите значение от 6 до 11<br>
      calc(30d/9+1d*5) можно делить, умножать, вычитать и складывать<br>
      calc(1d/3,5) вторым параметром через запятую можно задать степень округления, от 0 - только целые значения, до любого знака после запятой.
    </example>

    <h3>case_()</h3>
    Можно менять регистр букв в слове
    <example>
      case_u(МАМА мыла Раму) = МАМА МЫЛА РАМУ<br>
      case_l(МАМА мыла Раму) = мама мыла раму<br>
      case_t(МАМА мыла Раму) = Мама Мыла Раму<br>
      case_f(МАМА мыла Раму) = Мама мыла раму<br>
    </example>

    <h3>color()</h3>
    Здает цвет всего блока с текстом<br>
    Предустановленные цвета от 1 до 15 - как в мастерских досках
    <example>
      color(2)
    </example>

    <h3>if()</h3>
    Условие первым параметром передается само условие, доступные операнды:<br>
    = (равно)<br>
    != (не равно)<br>
    > (больше)<br>
    < (меньше)<br>
    >= (больше или равно)<br>
    <= (меньше или равно)<br>
    Вторым параметром через запятую идет текст, который появится если условие выполнено, третий параметр не обязательный - если условие не выполнено<br>

    <example>
      if({$a}=b,ура)<br>
      if({$a}!=b,правда,ложь)<br>
      if(calc(1d)>=3,удачно)
    </example>

    <h2>Спецсимволы</h2>
    <br>{n} символ переноса строки
    <br><b>&lt;b&gtЖирный&lt;/b&gt</b>
    <br><i>&lt;i&gtКурсив&lt;/i&gt</i>
    <br><u>&lt;u&gtПодчернутый&lt;/u&gt</u>
    <br><s>&lt;s&gtЗачеркнутый&lt;/s&gt</s>
  </format>

  <item>
    <h2>Списки</h2>
    Одна из этих строк будет выбрана случайным образом.<br>
    <br>
    Игнорируются пустые строки (или состоящие из одних пробелов)<br>
    <br>
    Игнорируются комментарии - строки начинающиеся с символа # или //<br>
    <br>
    Одинаковые строки просто повышают вероятность появления. Т.е. если вы напишите<br>
    <example>
      Вася<br>
      Петя<br>
      Петя<br>
      Петя<br>
    </example>
    То "Петя" будет появляться в три раза чаще чем "Вася"<br>
    <br>
    Тексты в квадратных скобках перечисленные через запятую так-же выбираются случайно но не увеличиваются вероятность
    появления<br>
    К примеру<br>
    <example>
      Маг [земли,воды,воздуха,огня]<br>
      Воин<br>
      Вор<br>
    </example>
    "Маг", "Воин" и "Вор" будут выпадать с равной вероятность, но если выпадет "маг", то ему генерируется стихия.<br>
    <br>
    Также можно оставлять пустые значения через запятую<br>
    Например:<br>
    <example>
      Воин[,,,,-Охотник,-Маг]
    </example>
    Тут чаще будет выпадать просто "Воин", но иногда "Воин-Охотник" или "Воин-Маг"<br>
    <br>
    <h2>Включения из других списков</h2>
    Вы можете добавить в свой список данные из другого генератора.<br>
    <example>
      {second-names:d037d1a2773503b521dad57685b12dd4}
      Петровы
      Ивановы
    </example>
    Эта строка добавит к Петровым и Ивановым все second-names из генератора с id, указанным после двоеточия.<br>
    <br>
    <b>Внимание!</b> ссылка должна быть на режим просмотра!<br>
    Конечно если позже запрашиваемый генератор или список в нем исчезнет данные перестанут загружаться<br>
    <br>

    <h2>Префиксы</h2>
    Для включения в список специфических строк можно использовать префиксы<br>
    Это всегда одни символ или число в начале строки и двоеточие
    <example>
      Психолог<br>
      w:Медсестра<br>
      m:Шахтёр<br>
    </example>
    При вызове этого списка <b>{prof}</b> в нем будет только одна строка - "психолог". Но при вызове с префиксами <b>{prof:w}</b> или <b>{prof:m}</b> списки буду дополнены соответствующими строками<br>
    Конечно при вызове можно использовать и переменные - <b>{prof:{$sex}}</b><br>

    <h2>Проверка</h2>
    Добавляя новые строки вы можете проверить как будут генерироваться именно с этими текстами - просто выделите нужную
    строку(и) и нажмите <b>Alt-G</b>
  </item>



</hints>

<suggested-tags>
  Миры:
  <tag>Исторический</tag>
  <tag>Фэнтези</tag>
  <tag>Дикий запад</tag>
  <tag>Наше время</tag>
  <tag>Сталкер</tag>
  <tag>Fallout</tag>
  <tag>Киберпанк</tag>
  <tag>Космос</tag>
  <tag>Звездные воины</tag>

  <br>Типы:
  <tag>Инвентарь</tag>
  <tag>Раса</tag>
  <tag>Мета черта</tag>
  <tag>Генератор</tag>

  <br>TL:
  <tag>TL1</tag><tag>TL2</tag><tag>TL3</tag><tag>TL4</tag><tag>TL5</tag><tag>TL6</tag><tag>TL7</tag><tag>TL8</tag><tag>TL9</tag><tag>TL10</tag><tag>TL11</tag><tag>TL12</tag>

</suggested-tags></constants>

<script>
  var boardMode = false;
  var generatorMode = false;
  var templateMode = false;
  var publicLibMode = false;
  var standaloneMode = true;
</script>
<!--ace Редактор кода с хайлайтом-->
<script src="js/ace2/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="js/difflib.js?2"></script>
<script src="js/jquery.ui.resizable.snap.ext.js"></script>
<script src="js/jquery.ui.touch-punch.min.js"></script>

<script src="xmlEditor.js?rnd==6.0-donats-31" type="text/javascript"></script>
<script src="drag-drop.js?rnd==6.0-donats-31" type="text/javascript"></script>
<script src="advantages.js?rnd==6.0-donats-31" type="text/javascript"></script>
<script src="skills.js?rnd==6.0-donats-31" type="text/javascript"></script>
<script src="spells.js?rnd==6.0-donats-31" type="text/javascript"></script>
<script src="equipment.js?rnd==6.0-donats-31" type="text/javascript"></script>
<script src="containers.js?rnd==6.0-donats-31" type="text/javascript"></script>
<script src="gm-board.js?rnd==6.0-donats-31" type="text/javascript"></script>
<script src="generator.js?rnd==6.0-donats-31" type="text/javascript"></script>
<script src="tools.js?rnd==6.0-donats-31" type="text/javascript"></script>

<body class="standalone-mode">
<blank-message>
  <i class="fa fa-times-circle" style="float:right; cursor:pointer;"
     onClick="$('blank-message').fadeOut(300);"></i>
  Вы редактируете "каркас" для группы.<br>
  Все новые персонажи в этой группе будут создаваться из данного "каркаса".  <br>
  Однако уже созданые персонажи не подвергнутся изменениям.
</blank-message>
<view-message>
  <i class="fa fa-times-circle" style="float:right; cursor:pointer;" onClick="$('view-message').fadeOut(300);"></i>
  <char-message>
  Вы получили ссылку на просмотр.<br>Вы можете <a href="javascript:void(0);" onClick="location.href=location.href+'&add_to_profile=1'">добавить ее в свой профиль</a> или просто <a href="javascript:void(0);" onClick="$('view-message').fadeOut(300);">продолжать просмотр</a><br>
    Все изменения будут появлятся на экране автоматически
  </char-message>
  <template-message>
    Вы получили ссылку на шаблон.<br>Для того чтобы воспользоваться им (увидеь в своей билиотеке) необходимо <a href="javascript:void(0);" onClick="location.href=location.href+'&add_to_profile=1'">добавить шаблон в свой профиль</a>
  </template-message>
</view-message>
<low-speed-message>
  <i class="fa fa-times-circle" style="float:right; cursor:pointer;" onClick="$('low-speed-message').fadeOut(300);"></i>
  Расчет идет слишком медлено. Вы можете <a href="javascript:void(0);" onclick="$('body').addClass('manual-calc-mode')">отключить автоматический пресчет</a> персонажа.<br/>
  В любой момент можно будет включить автоматический режим вновь.
</low-speed-message>
<edit-char-message>
  <note>Автор разрешил правки</note>
  <button title="Автор разрешил редактирование" onclick="loadChar(currentChar); unsetViewerMode();"><i class="fa fa-pencil"></i> редактировать</button>
</edit-char-message>
<manual-calc>
  <note>Автоматический пересчет отключен</note>
  <button onclick='calcAll(true); $("manual-calc").addClass("disabled");'><i class="fa fa-calculator"></i> Пересчитать</button><br>
  <a href="javascript:void(0);" onclick="$('body').removeClass('manual-calc-mode').removeClass('low-speed-warning');">Включить автоматическйи режим</a>
</manual-calc>
<gm-mode-hints>
  <h1>Панель Мастера</h1>
  <p>1. Позволяет быстро переключатся между персонажами и доскам. Иконки слева и клавиши Ctrl-1..9</p>
  <p>2. Персонажи загружаются в режиме просмотра - вы не можете их "испортить", изменения не сохраняются.</p>
  <p>3. Мастерские "доски" загружаются в режиме редактирования - все изменения сохраняются.</p>
  <p>4. В верхней панели нужные мастеру броски в быстром доступе</p>
  <br>
  <h2>Немного советов</h2>
  <p>Используйте мастерские доски для быстрой записи игровых событий, и генерацию персонажей в них для того чтобы не забыть проходных персонажей (сохраняйте их на доску и делайте пометки)</p>
  <p>Подготавливайте конспект для игры на мастерской доске заранее</p>
  <p>Ставьте важных персонажей и нужные доски в верхнюю часть списка - и используйте горячие клавиши для перехода</p>
</gm-mode-hints>


<body-wrapper>
  <char class="scrollable-block">
    <sticky-block>
      <char-menu>
        <auth></auth>
        <script>$("auth").load("auth.php");</script>

        <a class="btn hide-in-standalone-mode" title="На главную страницу" href="index.phtml"><i class="fa fa-caret-left"></i></a>
        <a class="btn show-in-standalone-mode-only" title="Список сохраненных персонажей" onClick="showStandaloneCharsList();"><i class="fa fa-list"></i> <label>Персонажи</label></a>
        <!--<button class="show-in-android-mode-only" onClick="Android.switchOnline();"><i class="fa fa-toggle-on"></i> <label>Online</label></button>-->
        <!--<button class="show-in-android-mode-only" onClick="Android.switchOffline();"><i class="fa fa-toggle-off"></i> <label>Offline</label></button>-->

        <button onClick="saveCurrentChar()" id="saveBtn" disabled><i class="fa fa-floppy-o"></i><label>Сохранить</label></button>
        <mobile-char-menu>
          <button class="secondary" onClick="$('char-menu more').toggleClass('visible')"><i class="fa fa-ellipsis-v"></i>
          </button>
        </mobile-char-menu>
        <more>
          <button class="secondary hide-in-gm-mode" title="Отменить последнее действие (Ctrl-Z)" onClick="undoRestore();" disabled id="undoBtn"><i class="fa fa-share fa-flip-horizontal"></i></button>
          <button class="secondary hide-in-gm-mode" title="Восстановить последнее действие (Ctrl-shift-Z)" onClick="redoRestore();" disabled id="redoBtn"><i class="fa fa-share"></i></button>

          <button class="secondary hide-in-gm-mode hide-in-blank-mode hide-in-board-mode" title="Распечатать файл" onClick="window.print();"><i class="fa fa-print"></i> <label>Печать</label></button>

          <button class="secondary hide-in-gm-mode hide-in-viewer-mode hide-in-board-mode hide-in-standalone-mode" title="Ссылка на режим просмотра" onClick="window.open('editor.phtml?v='+reverseString(currentChar));"><i class="fa fa-eye"></i> <label>Просмотр</label></button>

          <button class="secondary" title="Открыть Basic set 4ed" onClick="window.open('books/basic_set_4ed_'+(($.cookie('books')=='eng')?'eng':'rus')+'.pdf?rnd=2#zoom=80&page=3','bs');"><i class="fa fa-book"></i> <label>Basic set</label></button>

          <button class="secondary hide-in-gm-mode" title="Скачать в виде файла" onClick="saveCharToFileDialog();"><i class="fa fa-download"></i> <label>Скачать</label></button>

          <button class="secondary hide-in-gm-mode" title="Загрузить файл поврех текущего персонажа" onClick="loadCharFromFile();"><i class="fa fa-file-o"></i> <label>Перезаписать</label></button>

          <!--button class="secondary hide-in-gm-mode hide-in-board-mode hide-in-standalone-mode" title="Скачать .gcs файл" onClick="location.href='gcs-download.php?c='+currentChar"><i class="fa fa-download"></i> <label>Скачать</label></button-->

          <!--button class="secondary hide-in-gm-mode hide-in-board-mode hide-in-viewer-mode hide-in-standalone-mode" title="Загрузить .gcs поврех текущего персонажа" onClick="loadGcs();"><i class="fa fa-file-o"></i> <label>Перезаписать</label></button-->

          <button class="secondary hide-in-gm-mode hide-in-blank-mode hide-in-standalone-mode" title="Создать копию" onClick="window.open('new-char.php?generate_from='+currentChar);"><i class="fa fa-copy"></i> <label>Дублировать</label></button>

          <button class="secondary hide-in-gm-mode hide-in-board-mode show-in-viewer-mode-only hide-in-standalone-mode" title="Просмотр карточки в укороченом виде" onClick="window.open('editor.phtml?v='+currentChar+'&npc=1');"><i class="fa fa-id-card-o"></i> <label>Карточка NPC (beta)</label></button>

          <button class="secondary hide-in-gm-mode hide-in-board-mode hide-in-viewer-mode hide-in-template-mode hide-in-standalone-mode" title="Сбросить персонажа на пустой лист" onClick="if (confirm('Очистить лист персонажа?')) loadChar('.char',false,function (){saveCurrentChar(true)});"><i class="fa fa-recycle"></i> <label>Очистить</label></button>


        </more>
        <page>
          <label>Масштаб:</label>
          <button class="secondary round" title="Приблизить лист" onClick="zoomPage(1);"><i class="fa fa-plus-circle"></i></button>
          <button class="secondary round" title="Отдалить лист" onClick="zoomPage(-1);"><i class="fa fa-minus-circle"></i></button>
        </page>


      </char-menu>
    </sticky-block>
        <button class="secondary round hide-in-board-mode ui-options-btn" title="Настройки" onClick="optionsPopup(true)"><i class="fa fa-cog"></i></button>
    <button class="secondary round hide-in-public-lib-mode hide-in-viewer-mode hide-in-board-mode ui-history-btn" title="История изменений" onClick="showHistory()"><i class="fa fa-calendar"></i></button>
    <button class="secondary round hide show-in-public-lib-mode hide-in-board-mode ui-user-history-btn" title="История груповых изменений" onClick="showUserHistory()"><i class="fa fa-users"></i></button>
    <button class="secondary round ui-discord-btn discord-color" title="Discord смена каналов / выключение" onClick="changeDiscordChannel(this)"><i class="icon-discord"></i></button>

    <board-buttons class='nosave hide-in-viewer-mode'>
      <expander><button onClick="$('board-buttons').toggleClass('expanded')" class="secondary round"><i class="fa fa-caret-down"></i></button></expander>

      <span class="note">Добавить: </span>
      <button onclick='addBoardText();' title="Текст"><i class='fa fa-file-o'></i></button>
      <button onclick='addBoardImageDialog();' title="Картинка"><i class='fa fa-file-image-o'></i></button>
      <button onclick='addBoardMarker();' title="Маркер"><i class='fa fa-thumb-tack'></i></button>
      <button onclick='addBoardCharacter();' title="Персонаж"><i class='fa fa-user'></i></button>
      <button onclick='addBoardIframe();' title="Сайт"><i class='fa fa-globe'></i> </button>
      <button onclick='addBoardButton("url","","");' title="Кнопка"><i class='fa fa-hand-pointer-o'></i> </button>
      <span class="deliminator"></span>
      <button onclick='showBoardPanel($(this),true)' class='secondary'  title="дейстиве с выделенныим объектами"><i class='fa fa-object-ungroup'></i></button>
      <button onclick='boardToggleGrid();' class='secondary' title="Прилипать к сетке (Ctrl+Alt+G)"><i class='fa fa-th fa-fw'></i></button>
      <button onclick='boardToggleSnap();' class='secondary' title="Прилипать к соседним объектам (Ctrl+Alt+H)"><i class='fa fa-magnet fa-fw'></i></button>
      <span class="deliminator"></span>
      <button onclick='showGenerator();'><i class='fa fa-user-secret'></i> Генератор</button>
    </board-buttons>
    <page-cut class="hide-in-board-mode"></page-cut>
    <last-char-date></last-char-date>
    <char-xml></char-xml>
  </char>

  <spell-charts>
    <buttons>
      <mobile-spell-charts-menu><button onClick="$('spell-charts buttons').toggleClass('visible')"><i class="fa fa-chevron-right"></i> <selected-collage>Выберете школу</selected-collage></button></mobile-spell-charts-menu>
      <button class="secondary round close" style="float:right" onclick='$("body").removeClass("show-spell-charts");'><i class="fa fa-close"></i></button>
    </buttons>
    <carts>
      <objects></objects>
      <img id="spell-charts-bg-img" src="spell-charts/page0.png"/>
    </carts>
  </spell-charts>

  <lib-menu-bars>
  <button class="secondary"><i class="fa fa-bars"></i></button>
</lib-menu-bars>
<infopopup class="empty"><expander onClick="$('infopopup').toggleClass('expand')"><i class="fa fa-caret-left"></i><i class="fa fa-caret-right"></i></expander><infopopup-box><button class="secondary round close"><i class="fa fa-close"></i></button><content>Здесь появится описание, когда вы выберете интересующую вас область</content></infopopup-box></infopopup>
<lib class="scrollable-block">
  <sticky-block>
    <lib-menu>
      <button onClick="loadLib('lib/Advantages&Dsiadvantages-rus.adq?rnd=6.0-donats-31',this)" class="button-thin loadLibAtStartup" title="Преимущества и недостатки из Basic Set с переводами и описаниями">Adv/Disadv</button>
      <button onClick="loadLib('lib/Quirks-rus.adq?rnd=6.0-donats-31',this)" class="button-thin" title="Большая коллекция причуд с переводами">Quirks</button>
      <button onClick="loadLib('lib/Skills-rus.skl?rnd=6.0-donats-31',this)" class="button-thin" title="Умения из Basic Set с переводами и описаниями">Skills</button>
      <button onClick="loadLib('lib/Magic-rus.spl?rnd=6.0-donats-31',this)" class="button-thin" title="Заклиения из Magic с переводами и описаниями">Magic</button>
      <button onClick="loadLib('lib/Equip-BS-rus.eqp?rnd=6.0-donats-31',this)" class="button-thin" title="Снаряжение из Basic Set с переводом">Equip</button>
      <button class="secondary more-btn"><i class="fa fa-ellipsis-v"></i></button>
      <more>
        <h1>С переводом</h1>
        <button style="margin:5px;" onClick="loadLib('lib/HighTech-rus.eqp?rnd=6.0-donats-31',this)" class="button-thin"><b>High Tech</b> Оружие с переводм и фотографиями</button>
        <button style="margin:5px;" onClick="loadLib('lib/LowTech-rus.eqp?rnd=6.0-donats-31',this)" class="button-thin"><b>Low Tech</b> Оружие и вещи с переводм и фотографиями</button>
        <button style="margin:5px;" onClick="loadLib('lib/Psionics-rus.adv?rnd=6.0-donats-31',this)" class="button-thin"><b>Psionic Powers</b> Способности, умения, техники, правила</button>

                <h1>Загрузить библиотеку из файла</h1>
        <input type="file" onChange="loadLib('upload');">
        
        
        <h1>Инструменты</h1>
        <span class="tools">
        <button onClick="loadLib('lib/Rules.list?rnd=6.0-donats-31',this); $('lib').addClass('visible');" class="button-thin secondary"><i class="fa fa-search"></i> <label><b>Глоссарий</b> Basic Set и Magic</label></button>
          <button onClick="toolSkillRoll()" class="button-thin secondary" title="Выполнить бросок умения"><i class="icon-dices"></i> <label>Проверка <b>умения</b></label></button>
          <button onClick="toolDiceRoll()" class="button-thin secondary" title="Выполнить броско кубиков"><i class="icon-dice"></i> <label><b>Бросок</b> кубов</label></button>
          <button onClick="toolMeleeAttack()" class="button-thin secondary" title="Выполнить бросок контактной атаки"><i class="icon-swords"></i> <label><b>Контактная</b> атака</label></button>
          <button onClick="toolRangedAttack()" class="button-thin secondary" title="Выполнить бросок дистанционной атаки"><i class="fa fa-crosshairs"></i> <label><b>Дистанционная</b> атака</label></button>
          <button onClick="toolActiveDefence()" class="button-thin secondary" title="Выполнить бросок активной защиты"><i class="fa fa-shield"></i> <label>Активная <b>защита</b></label></button>
          <button onClick="toolSpellCast()" class="button-thin secondary" title="Выполнить бросок сотворения заклиания"><i class="fa fa-magic"></i> <label>Сотворение <b>заклинания</b></label></button>
          <button onClick="toolHiking()" class="button-thin secondary" title="Калькулятор врмени путешествия"><i class="fa fa-blind"></i> <label>Время <b>Путешествия</b></label></button>
          <button onClick="toolCollisionDamage()" class="button-thin secondary" title="Калькулятор столкновений и падений"><i class="icon-fall"></i> <label><b>Столкновнения</b> и <b>падения</b></label></button>
          <button onClick="toolThrowing()" class="button-thin secondary" title="Калькулятор бросания предметов"><i class="icon-throw"></i> <label><b>Бросание</b> предметов</label></button>
          <button onClick="toolDemolition()" class="button-thin secondary" title="Калькулятор взрывчатки"><i class="fa fa-bomb"></i> <label><b>Взрывчатка</b></label></button>
          <button onClick="toolJumping()" class="button-thin secondary" title="Калькулятор Прыжков"><i class="icon-jumping"></i> <label><b>Прыжки</b></label></button>
        </span>

        <span class="rules">
          <h2>Таблицы и правила</h2>
          <block><button class='secondary folder-lib' title='SP и DR материалов' onClick="loadLib('lib/Tables/SP и DR материалов.html?rnd=6.0-donats-31',this)"> SP и DR материалов</button> <button class='secondary folder-lib' title='Боевые правила' onClick="loadLib('lib/Tables/Боевые правила.html?rnd=6.0-donats-31',this)"> Боевые правила</button> <button class='secondary folder-lib' title='Бросание и гранаты' onClick="loadLib('lib/Tables/Бросание и гранаты.html?rnd=6.0-donats-31',this)"> Бросание и гранаты</button> <button class='secondary folder-lib' title='Броски кубиков' onClick="loadLib('lib/Tables/Броски кубиков.html?rnd=6.0-donats-31',this)"> Броски кубиков</button> <button class='secondary folder-lib' title='Зоны попаданий' onClick="loadLib('lib/Tables/Зоны попаданий.html?rnd=6.0-donats-31',this)"> Зоны попаданий</button> <button class='secondary folder-lib' title='Капитал' onClick="loadLib('lib/Tables/Капитал.html?rnd=6.0-donats-31',this)"> Капитал</button> <button class='secondary folder-lib' title='Крит-Провал' onClick="loadLib('lib/Tables/Крит-Провал.html?rnd=6.0-donats-31',this)"> Крит-Провал</button> <button class='secondary folder-lib' title='Крит-Успех' onClick="loadLib('lib/Tables/Крит-Успех.html?rnd=6.0-donats-31',this)"> Крит-Успех</button> <button class='secondary folder-lib' title='Столкновения и падения' onClick="loadLib('lib/Tables/Столкновения и падения.html?rnd=6.0-donats-31',this)"> Столкновения и падения</button> <button class='secondary folder-lib' title='Страх' onClick="loadLib('lib/Tables/Страх.html?rnd=6.0-donats-31',this)"> Страх</button> </block>        </span>

        
      </more>
    </lib-menu>

    <lib-filter><input type="search" placeholder="Поиск"><select></select>
      <desc-search><label><input type="checkbox"> искать в описаниях</label></desc-search>
      <points title="В очках (учитывается только базовая стоимость)">
        <input type="number" step="1" value="" placeholder="от">
        <input type="number" step="1" value="" placeholder="до">
      </points>
      <types>
        <type-mental> Ментальные</type-mental>
        <type-physical> Физические</type-physical>
        <type-social> Социальные</type-social>
        <type-supernatural> Супер</type-supernatural>
        <type-exotic> Экзотик</type-exotic>
      </types>
      <price class="hide">
        <input type="number" min="0" step="50" value="" placeholder="от">
        <input type="number" min="0" step="50" value="" placeholder="до">
      </price>
      <tech_level class="hide">
        <input type="range" min="0" max="12" step="1" value="0">
        <input type="range" min="0" max="12" step="1" value="12">
      </tech_level>
      <weight class="hide" title="вес в фунтах">
        <input type="number" min="0" step="1" value="" placeholder="от">
        <input type="number" min="0" step="1" value="" placeholder="до">
      </weight>
      <legality_class class="hide">
        <input type="range" min="0" max="4" step="1" value="0">
        <input type="range" min="0" max="4" step="1" value="4">
      </legality_class>


    </lib-filter>
  </sticky-block>
  <lib-xml></lib-xml>
</lib>  <script src="lib.js?rnd==6.0-donats-31" type="text/javascript"></script>



  <float-panel>
<!--
    <attack class="item" onClick="toolRangedAttack(floatPanelObj); $('float-panel').hide();">
      <i class="fa fa-fire fw"></i> Огонь!
      <note>F4</note>
    </attack>
-->
    <colors></colors>
    <view-details class="item" onClick="viewDescription(floatPanelObj,true); $('float-panel').hide();">
      <i class="fa fa-info-circle fw"></i> Описание
      <note>F1</note>
    </view-details>
    <change-item class="item hide-in-viewer-mode" onClick="changeItem (floatPanelObj); $('float-panel').hide();">
      <i class="fa fa-pencil-square fw"></i> Изменить настройки
      <note>Double click</note>
    </change-item>
    <convert-to-container class="item hide-in-viewer-mode" onClick="convertEquipmentToContainer(floatPanelObj); $('float-panel').hide();">
      <i class="fa fa-folder"></i> Превратить предмет в группу
    </convert-to-container>
    <convert-to-equipment class="item hide-in-viewer-mode" onClick="convertContainerToEquipment(floatPanelObj); $('float-panel').hide();">
      <i class="fa fa-folder"></i> Превратить группу в предмет
    </convert-to-equipment>

    <sort class="item hide-in-viewer-mode" onClick="sortList(floatPanelObj); $('float-panel').hide();">
      <i class="fa fa-sort"></i> Сортировать группу
    </sort>
    <add-note class="item hide-in-viewer-mode" onClick="addNote(floatPanelObj); $('float-panel').hide();">
      <i class="fa fa-sticky-note-o fw"></i> Добавить заметку
    </add-note>
    <edit-xml class="item hide-in-viewer-mode" onClick="editXML(floatPanelObj); $('float-panel').hide();">
      <i class="fa fa-file-code-o fw"></i> Редактировать
      <note>F4</note>
    </edit-xml>
    <stop-start class="item hide-in-viewer-mode" onClick="advantageStopStart(floatPanelObj); $('float-panel').hide();">
      <i class="fa fa-stop-circle fw"></i> Отключить / Включить
    </stop-start>
    <container-stop class="item hide-in-viewer-mode" onClick="advantagesContainerStopStart(floatPanelObj,false); $('float-panel').hide();">
      <i class="fa fa-stop-circle fw"></i> Отключить все
    </container-stop>
    <container-start class="item hide-in-viewer-mode" onClick="advantagesContainerStopStart(floatPanelObj,true); $('float-panel').hide();">
      <i class="fa fa-play-circle fw"></i> Включить все
    </container-start>



    <label class="hide-in-viewer-mode">Преместить:</label>
    <move-up class="item hide-in-viewer-mode" title="Поднять вверх (Ctrl - Up)" onClick="moveItem(floatPanelObj,'up');">
      <i class="fa fa-arrow-up fa-lg"></i>
    </move-up>
    <move-down class="item hide-in-viewer-mode" title="Опустить вниз (Ctrl - Down)"  onClick="moveItem(floatPanelObj,'down');">
      <i class="fa fa-arrow-down fa-lg"></i>
    </move-down>
    <move-left class="item hide-in-viewer-mode" title="Убрать из группы (Ctrl - Left)" onClick="moveItem(floatPanelObj,'left');">
      <span class="fa-stack"><i class="fa fa-folder-o fa-stack-2x"></i><i class="fa fa-angle-left fa-stack-1x"></i></span>
    </move-left>
    <move-right class="item hide-in-viewer-mode" title="В ближайшую группу (Ctrl - Right)" onClick="moveItem(floatPanelObj,'right');">
      <span class="fa-stack"><i class="fa fa-folder-o fa-stack-2x"></i><i class="fa fa-angle-right fa-stack-1x"></i></span>
    </move-right>
    <add-page-break class="item hide-in-viewer-mode" onClick="addPageBreak(floatPanelObj); $('float-panel').hide();">
      <i class="fa fa-scissors fw"></i> Разрыв страницы при печати
    </add-page-break>

    <duplicate class="item hide-in-viewer-mode" onClick="duplicateItem(floatPanelObj); $('float-panel').hide();">
      <i class="fa fa-copy fw"></i> Создать копию
    </duplicate>

    <copy class="item" onClick="copyToStorage(floatPanelObj); $('float-panel').hide();">
      <i class="fa fa-clipboard fw"></i> В буфер обмена
    </copy>

    <past class="item hide-in-viewer-mode" onClick="pastFromStorage(floatPanelObj); $('float-panel').hide();">
      <i class="fa fa-clipboard fw"></i> Вставить из буфера
    </past>

    <delete class="item hide-in-viewer-mode" onClick="deleteItem(floatPanelObj); $('float-panel').hide();">
      <i class="fa fa-trash fw"></i> Удалить
      <note>Del</note>
    </delete>
  </float-panel>
  <script>
    for (var i=0;i<16;i++) {
      $("<color></color>").attr("color",i).bind("click",function (){
        var color=$(this).attr("color");
        floatPanelObj.attr("color",color);
        if (color==0) floatPanelObj.removeAttr("color");
        saveButtonEnable();

      }).appendTo("float-panel colors");
    }
  </script>

  <spinn-panel>
    <roll onClick="toolSkillRoll($(spinnObj)); hideSpinnPanel();"></roll>
    <plus onClick="spinn(spinnObj,1); $(spinnObj).focus(); $(spinnObj).change();"></plus>
    <minus onClick="spinn(spinnObj,-1); $(spinnObj).focus(); $(spinnObj).change();"></minus>
  </spinn-panel>
  <profile-panel class="use-zoom">
    <expander onClick="$(this).parent().toggleClass('show-panel'); $(profileObj).focus();"></expander>
    <add title="Добавить новое поле" onClick="profileItemAdd(profileObj); $(profileObj).focus()"></add>
    <delete title="Удалить" onClick="if (confirm('Точно удалить')) {$(profileObj).remove(); saveButtonEnable();} $(profileObj).focus();"></delete>
    <left title="Свдинуть влево" onClick="profileSwap(profileObj,true); $(profileObj).focus()"></left>
    <right title="Сдвинуть вправо" onClick="profileSwap(profileObj,false); $(profileObj).focus()"></right>
  </profile-panel>
</body-wrapper>
</body>


<script>

  var globalChar=$("char-xml");
  var globalCalced=false;

  var blankMode = (getURLParameter("blank"));
  if (blankMode) $("body").addClass("blank-mode");

  if (isTouchDevice()) $("body").addClass("touch-device");

  var currentChar=getURLParameter('c');

  var gmMode = (getURLParameter("gm") !== null);

  var viewerMode = (getURLParameter("v") !== null);

  if (getURLParameter("npc")) {$("body").addClass("npc-view");}

  var androidMode=(typeof (Android)==="object");
  if (androidMode) {$("body").addClass("android-mode");}

  updateDiscord();

  if (viewerMode) {
    currentChar=reverseString(getURLParameter('v'));
    $("body").addClass("viewer-mode");
    loadChar(currentChar);
    setInterval(function () {
      if ($("body").hasClass("no-auto-update")) return;
      $.post("save.php", {fileName: reverseString(getURLParameter('v')), checkForUpdate: 1}).done(function (d) {
        if (d != $("last-char-date").html()) {
          if (globalChar.find(".changed").length){
            modalPopup("Персонаж был изменен кем-то другим",
                "Загрузить измененный с сервера",
                "Не загружать",
                function () {
                  loadChar(currentChar, true);
                },
                function () {
                  $("last-char-date").html(d);
                });
          }
          else{
            loadChar(currentChar, true);
          }
        }
      });
    }, 10000) // Каждые 10 секунд
  }
  else if (gmMode) {
    $("body").addClass("gm-mode");
    $("body").addClass("lib-standalone");

    var rulesExpand=$("<button class='secondary'><i class='fa fa-fw fa-caret-right'></i> Правила</button>").on("click",function(){
      $(this).find("i").toggleClass("fa-caret-right fa-caret-down");
      $(this).parent().find(".rules block").toggleClass("hide");
    });
    var rules=$("lib-menu .rules").clone();
    rules.find("button").on("click",function(){
      $("lib").addClass("visible");
    });
    $("char-menu more")
      .append(rules)
      .append(rulesExpand)
      .append($("lib-menu .tools").clone());

    $("char-xml").html($("gm-mode-hints").html());

    $("gm-chars .my-char").on('click',function(){
      saveCurrentChar();

      currentChar=$(this).attr('char-link').replace("view_","");

      if ($(this).hasClass("my-board")) unsetViewerMode();
      else setViewerMode();

      loadChar(currentChar,false,function (){
        autoZoom();
      });
      $("gm-board").hide();
      return false;
    });

    renderBoard();
  } else if(standaloneMode&&currentChar===null){
    showStandaloneCharsList();
  } else
  {
    loadChar(currentChar);
  }

  function lockCurrentChar(){

    if (viewerMode) return;

    if (lastActiveTime+120000<Date.now()) {
//       по таймауту сабмитим модальный диалог, дальше будет сохранение
      $("modalpopup .ok").click();
      saveCurrentChar();
      setViewerMode();
      return;
    }

    $.post("save.php", {fileName: currentChar, lock: 1}).done(function (d) {
      if (d.substr(0,10) == 'locked by '){
        showCharLocked(d.substr(10));
      }
    });
  }

  function showCharLocked(id){
    modalPopup("Сейчас редактирует <a onclick='showUserInfo("+id+")'>другой пользователь</a>, дождитесь освобождения","Ок");
    loadChar(currentChar);
    setViewerMode();
  }

  if (publicLibMode){
    $("body").addClass("public-lib-mode");
    setInterval(lockCurrentChar,1000);
  }

  function showStandaloneCharsList(){
    saveCurrentChar();
    unloadChar();
    modalPopup(`<h3>Cохраненные персонажи</h3>
      <button onclick='getStandaloneChar();'><i class='fa fa-cloud-download'></i> Загрузить из ментора</button>
      <br><br>
      <button onclick="createStandaloneChar(standaloneTplChar);"><i class="fa fa-plus-circle"></i> Новый персонаж</button>
      <button onclick="createStandaloneChar(standaloneTplTpl);" class="template"><i class="fa fa-puzzle-piece"></i> Новый Шаблон</button>
      <button onclick="createStandaloneChar(standaloneTplBoard);" class="board"><i class="fa fa-user-secret"></i> Новая Доска</button>

      <list></list>
      <line class="note">Синхронизировать необходимо самому, автоматической синхронизации нет</line>
      <line class="note">При удалении удаляется только локальная капия, в "большом" менторе все останется</line>`
      ,null,"Закрыть");

    var stuffsaved = Object.keys(localStorage);
    for (var i = 0 ; i < stuffsaved.length ; i++ ) {
      if (stuffsaved[i].substr(0,5)=="char_"){

        var html=localStorage.getItem(stuffsaved[i]);
        var el=$(html);
        var hash=stuffsaved[i].substr(5);
        var name=el.find("name").first().html();
        if (name=="") name="[Имя на задано]";

        var isTemplate=(html.indexOf("<template")>=0);
        var isBoard=(html.indexOf("<gm-board")>=0);

        var base = (el.find("portrait").html()||"").replace(/(\r\n|\n|\r)/gm, "");
        var portrait="background-image:url(data:image/png;base64,"+base+")";
        var isLocal=(hash.substr(0,5)=="local");


        var item=$(`<div class="my-char">

            <a class="my-char-name" href='editor.html?c=`+hash+`'><div class="my-char-avatar" style="`+portrait+`"></div><span class="my-char-name-text">`+name+`</span></a>
            <a class='my-char-view-link' class='secondary round' title="Синхронизировать с ментором" onclick="syncStandaloneChar('`+hash+`',this)"><i class='fa fa-refresh'></i></a>
            <a class='my-char-delete' class='secondary round' title="Удалить" onClick="if(confirm('Точно удалить?')) {localStorage.removeItem('char_`+hash+`'); showStandaloneCharsList();}"><i class='fa fa-trash'></i></a>
            <div class="my-char-server" style="display: none; text-align: right;width: 100%;">На сервере mentor более новая версия<br>
              <button onClick="getStandaloneCharForce('`+hash+`'); $(this).parent().hide();">скачать с сервера</button>
              <button onClick="putStandaloneCharForce('`+hash+`'); $(this).parent().hide();">залить на сервер новую</button>
            </div>
          </div>`);

        if (isTemplate) item.addClass("my-template");
        if (isBoard) item.addClass("my-board");
        if (isLocal) {
          item.find(".my-char-view-link").hide();
          item.attr("title", "Локальынй (не синхронизируемый) персонаж")
        }
        item.appendTo("modalpopup list");
      }
    }
  }

  function createStandaloneChar(createFrom){
      var i=1;
      while(localStorage.getItem("char_local_"+i)!==null) {i++;}
      localStorage.setItem("char_local_"+i,createFrom);
      location.href='editor.html?c=local_'+i;
  }

  function getStandaloneChar(){
    $.ajax({type: "GET",url: mentorUlr+"/chars-list-standalone.php?userId="+localStorage.getItem("userId"),dataType: "html",cache: false,contentType: "application/xhtml+xml;charset=utf-8",
      success: function (result) {
        if (result=="wrong id") {
          setSandaloneAuth();
        }
        else{
          modalPopup("<line id='standalone-list'>"+result+"</line>","Закрыть",null,null,null,function(){
            var list=$("modalpopup #standalone-list");
            list.find(".my-chars-buttons,.my-campaign-toolbar-expander").remove();
            list.find(".my-char-avatar").each(function(){
              $(this).attr("data-src",mentorUlr+"/"+$(this).attr("data-src"));
            });
            setLazyLoad();

            $("<button class='secondary'>Выйти из ментора</button>").on("click",function(){localStorage.setItem("userId",""); showStandaloneCharsList();}).appendTo(list);

            list.find(".my-char-name").on("click",function () {
              if ($(this).parent().hasClass("view-only")) {
  //              todo
                flyAlert("Пока ссылки для чтения не загружаем, извините",$(this))
                return false;
              }
              var charName=$(this).parent().attr("char-link");
              getStandaloneCharForce(charName,function(){location.href='editor.html?c='+charName;});
              return false;
            });
          });
        }
      },
      error: function (){flyAlert("Загузить не удалось")}
    });
  }

  function getStandaloneCharForce(charName,cb){
    $.ajax({type: "GET",url: mentorUlr+"/chars/"+charName,dataType: "html",cache: false,contentType: "application/xhtml+xml;charset=utf-8",
      success: function (result) {
        localStorage.setItem("char_"+charName,result);
        if (cb) cb();
      },
      error: function (){flyAlert("Загузить не удалось")}
    });
  }
  function goCurrnetChar(){
    location.href="editor.phtml?c="+currentChar;
  }

  function putStandaloneCharForce(charName,cb){
    $.post("http://mentor.gurps.ru/save.php", {fileName: charName, forceSave: true, xml: localStorage.getItem("char_"+charName)}).done(function (d) {
      getStandaloneCharForce(charName, cb);
    });
  }

  function syncStandaloneChar(hash,obj){
    $(obj).find(".fa").addClass("fa-spin");
    $.ajax({type: "GET",url: "http://mentor.gurps.ru/chars/"+hash,dataType: "html",cache: false,contentType: "application/xhtml+xml;charset=utf-8",
      success: function (result) {
        if ($(result).find("modified_date").html()==$(localStorage.getItem("char_"+hash)).find("modified_date").html()) {
          if (result===localStorage.getItem("char_"+hash)){
            $(obj).find(".fa").removeClass("fa-spin");
            flyAlert("Нет изменений на сервере",obj)
          } else {
            putStandaloneCharForce(hash,function(){
              $(obj).find(".fa").removeClass("fa-spin");
              flyAlert("Загружено в Ментор",obj)
            });
          }
        } else {
          $(obj).find(".fa").removeClass("fa-spin");
          $(obj).siblings(".my-char-server").show();
          echo ("изменилось в менторе");
        }

      },
      error: function (){flyAlert("Загузить не удалось")}
    });
  }



  function setSandaloneAuth(){
    modalPopup(`<h3>Авторизация</h3>
    <line>Вам необходимо получить авторизационный ключ в gurps.mentor.ru открыв его в броузере</line>
    <line>Там нажмите на иконку с вашим именем (справа сверху) и найдите иконку <i class="fa fa-shield"></i> </line>
    <input type='text' style='width:100%' placeholder='Скопируйте сюда полученный ключ'>`,"сохранить","отмена",function(){
      localStorage.setItem("userId",$("modalpopup input").val());
      getStandaloneChar();
    });
  }


  function saveChar(fileName, cb, forceSave) {
    if (viewerMode) return;

    var obj = globalChar.clone();
    clearObj(obj);

    if (standaloneMode) {
      localStorage.setItem("char_"+currentChar,$(obj).html())

      cb();
    }
    else {
      $.post("save.php", {
        fileName: fileName,
        forceSave: forceSave,
        lastDate: $("last-char-date").html(),
        xml: $(obj).html()
      }).done(function (d) {
        if (d == 'update early') modalPopup("Персонаж был изменен кем-то другим",
          "Сохранить мой варинт",
          "Загрузить измененный с сервера",
          function () {
            saveCurrentChar(true)
          },
          function () {
            loadChar(currentChar);
          });
        else if (d.substr(0,10) == 'locked by '){
          showCharLocked(d.substr(10));
        }
        else {
          //установить новую дату
          $("last-char-date").html(d);
        }
        cb();
      }).fail(function() {
        flyAlert('Сохранить не удалось, ошибка соединения',$("#saveBtn"));
        cb();
      });
    }
  }

  function saveCurrentChar(forceSave,cb) {
    if (viewerMode) return;
    if (($("#saveBtn").prop('disabled')||$("#saveBtn").hasClass('loading')) && !forceSave) {
      if(cb) cb();
      return
    }
    $("#saveBtn").addClass("loading").prop('disabled', true);
    saveChar(currentChar, function () {
      $("#saveBtn").removeClass("loading");
      if(cb) cb();
    }, forceSave)
    if (publicLibMode) publicLibClearMarkers()
  }
  setInterval(saveCurrentChar, 10000) // каждые 10 секунд! (много!)

  function saveButtonEnable() {
    if (viewerMode) return;
    $("#saveBtn").prop('disabled', false);
  }

  // todo
  function setMode(mode){
    var css=mode.replace(/[A-Z]/g,(t)=>"-"+t.toLowerCase());
    $("body").addClass(css);
    eval(mode+"=true");
  }
  function unsetMode(mode){
    var css=mode.replace(/[A-Z]/g,(t)=>"-"+t.toLowerCase());
    $("body").removeClass(css);
    eval(mode+"=false");
  }


  function setViewerMode(){setMode("viewerMode");}
  function unsetViewerMode(){unsetMode("viewerMode");}


//  function loadGcs() {
//    modalPopup("Загрузить .gcs поверх текущего персонажа<br> ! Внимание загрузка .gcs может быть опасна. Текущий персонаж будет полностю удален.<br>" +
//      "<form id='gcs-upload' action='gcs-upload.php' method='post' enctype='multipart/form-data'><input type='hidden' name='c' value='" + getURLParameter('c') + "'> <input type=file name='upfile'></form>",
//      "Загрузить",
//      "Отмена",
//      function () {
//        $("#gcs-upload").submit();
//      });
//  }

  function loadCharFromFile(){
    var lastDate=$("last-char-date").html();
    modalPopup("<h3>Текущий персонаж будет полностю удален.</h3><input type=file accept='.xml,.gcs,.gct'><br><label><input type='checkbox'> Импортровать как лист персонажа / шаблон из GCS</label>","Заугрузить","Отмена",function(){
      //currentChar="";
      var fileReader = new FileReader();
      fileReader.onload = function(fileLoadedEvent){
        charLoaded(fileLoadedEvent.target.result);
        var d = new Date();
        $("last-char-date").html(lastDate);
        saveButtonEnable()
        saveCurrentChar();
      };
      fileReader.readAsText($("modalpopup input")[0].files[0], "UTF-8");
    },null,function(){

    });
  }

  function saveCharToFileDialog(){
    modalPopup(`
    <style>modalpopup message button {min-width:250px;} modalpopup .note {margin:5px 20px 20px;}</style>
    <button onClick="saveCharToFile(); modalPopupClose();"><i class="fa fa-download"></i> Файл ментора </button>
    <div class='note'>.xml - нужен для воссановления персонажа в меноторе и для офлайн версии</div>

    <button class='pale' onClick="location.href='roll20-download.php?c='+currentChar; modalPopupClose();"><i class="fa fa-download"></i> Файл для Roll20</button>
    <div class='note'>.json - огромное спасибо est0y за этот экспортер</div>

    <button class='pale' onClick="location.href='gcs-download.php?c='+currentChar; modalPopupClose();"><i class="fa fa-download"></i> Файл для GCS</button>
    <div class='note'>.gcs - файл старого образца (работает не стабильно, извините)</div>

    <button class='pale' onClick="loadScript('foundry-vtt-export.js');"><i class="fa fa-download"></i> Файл для Foundary-VTT</button>
    <div class='note'>.xml - экспортер сделал Godknows, огромное спасибо!<br>В настройках foundary обязательно выбрать Import file encoding: UTF-8</div>


    `,null,"Закрыть")
  }

  function saveCharToFile(){

    var obj = globalChar.clone();
    clearObj(obj);

    var name=globalChar.find("profile>name").text();
    if (name=="") name="[Имя не задано]";
    name+=".xml";
    var download = document.createElement("a");
    download.href = "data:text/plain;content-disposition=attachment;filename=file," + obj.html().replace(/#/gm,"%23");
    download.download = name;
    download.style.display = "none";
    download.id = "download"; document.body.appendChild(download);
    document.getElementById("download").click();
    document.body.removeChild(download);
  }

  function unloadChar(){
    currentChar=null;
    globalChar.html("");
    unsetMode("templateMode");
    unsetMode("boardMode");
    unsetMode("generatorMode");
    undoClear();
    undoRedoAfter();
    $("#saveBtn").prop('disabled', true);
  }

  function loadChar(fileName, silent, cb) {
    globalCalced=false;
    undoClear();
    if (!silent) {
      globalChar.html("<loading/>");
      $("#saveBtn").prop('disabled', true);
    }

    if (standaloneMode) {
      charLoaded(localStorage.getItem("char_"+fileName),null,cb);
    }

    $.ajax({
      url: "./chars/" + fileName,
      dataType: "html",type: "GET",cache: false, contentType: "application/xhtml+xml;charset=utf-8",
      success: function (result, status, request) {
        charLoaded(result,request.getResponseHeader('Last-Modified'),cb)
      }
    });
  }

  function charLoaded(xml,lastMod,cb){

    // необходимо, поскольку template зарезервированый тег
    xml = xml.replace("<template ", "<template-fix ");
    xml = xml.replace("<template>", "<template-fix>");
    xml = xml.replace("</template>", "</template-fix>");

    var d = new Date(lastMod);
    $("last-char-date").html(d.getTime());
    globalChar.html($(xml));
    unsetMode("boardMode");
    unsetMode("templateMode");
    unsetMode("generatorMode");
    if (globalChar.find("template-fix").length) {
      setMode("templateMode");
    }
    if (globalChar.find("gm-board").length) {
      $("lib").removeClass("visible");
      setMode("boardMode");
      renderBoard();
    }
    if (globalChar.find("generator").length) {
      $("lib").removeClass("visible");
      setMode("generatorMode");
      renderGenerator();
    }
    if (publicLibMode&&!viewerMode) {
      publicLibClearMarkers();
      globalChar.find("*[deleted=true]").remove();
    }

    if (publicLibMode&&$("body").hasClass("show-changes-only")) showChangesOnly();

    if (!publicLibMode) publicLibClearMarkers();
    renderChar();

    updateGlobalLists();
    updateBrowserTitle()

    if (globalAllList.length>200){
      $('body').addClass('manual-calc-mode');
      flyAlert("Авто пересчет отключен из за количества объектов",$("body"));
      calcAll(true,true);
    }
    else {
      calcAll();
    }

    if (cb) cb();
  }



  function loadCharFromHistory(fileName,compare){
    saveCurrentChar();
    setViewerMode();
    $("body").addClass("no-auto-update");
    loadChar(fileName,false,function(){
//      if (compare.length>0) compareCharWith("history/"+currentChar+"/"+compare);
    });
  }

  function restoreCharFromHistory(fileName) {
    saveCurrentChar();
    modalPopup("<h1>Вы уверены что необходимо восстановить эту версию?</h1><p>Восстановление будет записано как очередное сохранение, так что его так-ж можно будет откатить</p>"
      ,"Восстановить","Отмена",function (){
        $("infopopup").addClass("empty");
        unsetViewerMode();
        loadChar(fileName,false,function(){
          publicLibClearMarkers();
          saveCurrentChar(true)
        });
      });
  }

  function updateBrowserTitle(){
    var name=globalChar.find("profile>name,gm-board>name").text();
    if (name=="") name="[Имя не задано]";
    $("html>head>title").html(name+" - GURPS Mentor");
  }

  function showHistoryDiff(link1,link2){
        modalPopup("<diff><loading></loading></diff>","ok",null,null,null,function (){
          $("modalpopup").addClass("wide");

          $.when( $.ajax( link1 ),$.ajax( link2) ).then(function( d1,d2 ) {
            function prepareObj(d){
              var obj=$("<i>"+d+"</i>");
              $(obj).find("history").remove();
              publicLibClearMarkers(obj);
              return $(obj).html();
            }


            var lines1=difflib.stringAsLines(prepareObj(d1[0]));
            var lines2=difflib.stringAsLines(prepareObj(d2[0]));

            var sm = new difflib.SequenceMatcher(lines1, lines2);


            // build the diff view and add it to the current DOM
            $("modalpopup diff").html(diffview.buildView({
              baseTextLines: lines1,
              newTextLines: lines2,
              opcodes: sm.get_opcodes(),
              contextSize: 3,
              viewType: 1
            }))
          });
        });
  }


  function publicLibClearMarkers(obj){
    if (!obj) obj=globalChar;
    $(obj).find("*").removeAttr("changed moved");
    $(obj).find("*[deleted=true]").remove();
  }

  function setModifyAttr(obj,type){
    if (publicLibMode) $(obj).attr(type,'true');
  }




  function renderChar() {

    // правим ошибки старых версий
      //    globalChar.find("*[level_mod='yes']").removeAttr('level_mod').attr('per_level','yes')

    // проверка на наличае важнейших элементов
    {
      function addTagIfNotExists(name, path, mode, element, value) {
        value = value || "";
        if (globalChar.find(path + name).length == 0) {
          var tag = "\n<" + name + ">" + value + "</" + name + ">\n";
          if (mode == "append") globalChar.find(element).append(tag);
          if (mode == "prepend") globalChar.find(element).prepend(tag);
          if (mode == "after") globalChar.find(element).after(tag);
          if (mode == "before") globalChar.find(element).before(tag);
        }
      }

      addTagIfNotExists("name", ">character>profile>", "prepend", ">character>profile");
      addTagIfNotExists("tech_level", ">character>profile>", "after", ">character>profile>name", "8");

      addTagIfNotExists("advantage_list", ">character>", "append", ">character");
      addTagIfNotExists("skill_list", ">character>", "append", ">character");
      addTagIfNotExists("spell_list", ">character>", "append", ">character");
      addTagIfNotExists("equipment_list", ">character>", "append", ">character");
      addTagIfNotExists("notes", ">character>", "append", ">character");
      addTagIfNotExists("history", ">character>", "append", ">character");

      //addTagIfNotExists("profile", ">character>", "before", ">advantage_list");

      addTagIfNotExists("portrait", ">character>profile>", "append", ">character>profile");
      addTagIfNotExists("notes", ">character>profile>", "before", ">character>profile>portrait", "0");
      addTagIfNotExists("sm", ">character>profile>", "before", ">character>profile>notes");

      addTagIfNotExists("total_points", ">character>", "after", ">character>profile","100");
      addTagIfNotExists("earn_points", ">character>", "after", ">character>total_points","0");
      addTagIfNotExists("disadvantages_threshold", ">character>", "after", ">character>profile","-40");
      addTagIfNotExists("quirks_threshold", ">character>", "after", ">character>profile","-5");


      //todo статы и вторичные статы

      addTagIfNotExists("hp_lost", ">character>", "after", "move");
      addTagIfNotExists("fp_lost", ">character>", "after", "move");
      //undone


      // Template
      addTagIfNotExists("advantage_list", ">template-fix>", "prepend", ">template-fix");
      addTagIfNotExists("skill_list", ">template-fix>", "after", ">template-fix>advantage_list");
      addTagIfNotExists("spell_list", ">template-fix>", "after", ">template-fix>skill_list");
      addTagIfNotExists("equipment_list", ">template-fix>", "after", ">template-fix>spell_list");
      addTagIfNotExists("notes", ">template-fix>", "after", ">template-fix>spell_list");
      addTagIfNotExists("history", ">template-fix>", "append", ">template-fix");

      addTagIfNotExists("profile", ">template-fix>", "prepend", ">template-fix");
      addTagIfNotExists("name", ">template-fix>profile>", "append", ">template-fix>profile","Название");
      addTagIfNotExists("notes", ">template-fix>profile>", "after", ">template-fix>profile>name","");
      addTagIfNotExists("portrait", ">template-fix>profile>", "append", ">template-fix>profile");

//      addTagIfNotExists("declaration", ">template-fix>", "prepend", ">template-fix");
//      addTagIfNotExists("name", ">template-fix>declaration>", "append", ">template-fix>declaration");
      addTagIfNotExists("spend_points", ">template-fix>", "prepend", ">template-fix");

    }

    globalChar.find("profile>*").addClass("editable");

    if (globalChar.find("profile portrait").length == 0) globalChar.find("profile").append("<portrait></portrait>");
    globalChar.find("profile").prepend("<portrait-img class='nosave'></portrait-img>");
    portraitShow();

    globalChar.find("profile tech_level").addClass('spinner spinner-not-negative editable');

    globalChar.find("profile sm").after("<SM_result class='nosave spinner editable result-reverse'/>");

    globalChar.find("profile").before("<minimizer class='nosave profile_minimizer'></minimizer>");

    if (!templateMode&&!boardMode&&!generatorMode) {

      globalChar.find("profile").after("<HP_result class='nosave'/><WILL_result class='nosave'/><PERCEPTION_result class='nosave'/><FP_result class='nosave'/><move_result class='nosave'/><speed_result class='nosave'/>" +
          "<will_add class='nosave'/><perception_add class='nosave'/><move_add class='nosave'/><st_add class='nosave'/>")

      globalChar.find("profile").after("<ST_bonus class='nosave bonus'/><DX_bonus class='nosave bonus'/><IQ_bonus class='nosave bonus'/><HT_bonus class='nosave bonus'/><HP_bonus class='nosave bonus'/><WILL_bonus class='nosave bonus'/><PERCEPTION_bonus class='nosave bonus'/><FP_bonus class='nosave bonus'/><move_bonus class='nosave bonus'/><speed_bonus class='nosave bonus'/><dodge_bonus class='nosave bonus'/><parry_bonus class='nosave bonus'/><block_bonus class='nosave bonus'/><SM_bonus class='nosave bonus'/><ST_strike_bonus class='nosave bonus'/><ST_lift_bonus class='nosave bonus'/><encumbrance_bonus class='nosave bonus'/>" +
          "<hearing_bonus class='nosave bonus'/><taste_smell_bonus class='nosave bonus'/><touch_bonus class='nosave bonus'/><vision_bonus class='nosave bonus'/><fright_check_bonus class='nosave bonus'/><air_move_bonus class='nosave bonus'/><ground_move_bonus class='nosave bonus'/><space_move_bonus class='nosave bonus'/><water_move_bonus class='nosave bonus'/><reaction_bonus class='nosave bonus'/>");

      globalChar.find("profile").after("<ST_cost_modifier class='nosave cost-modifier'/><DX_cost_modifier class='nosave cost-modifier'/><IQ_cost_modifier class='nosave cost-modifier'/><HT_cost_modifier class='nosave cost-modifier'/><HP_cost_modifier class='nosave cost-modifier'/>");

      globalChar.find("speed,speed_result").addClass("spinner-quarter float");

      globalChar.find("hp_lost,fp_lost").addClass("editable");

      globalChar.find("profile").after("<ST_result class='nosave'/><DX_result class='nosave'/><IQ_result class='nosave'/><HT_result class='nosave'/>");

      globalChar.find("ST_result,DX_result,IQ_result,HT_result,hp_result,will_result,perception_result,fp_result,move_result,speed_result").addClass("spinner spinner-not-negative editable result-reverse");

      globalChar.find("ST_result,DX_result,IQ_result,HT_result,will_result,perception_result").addClass("spinner-tool-btn");

      globalChar.find("ST_result,DX_result,IQ_result,HT_result").after("<gc-cost class='nosave attr_cost'></gc-cost>")
      globalChar.find("hp,fp,will,perception,speed,move").each(function () {
        $(this).after("<gc-cost class='nosave second_attr_cost " + $(this)[0].tagName + "_cost'></gc-cost>");
      });
    }


    globalChar.find("character>advantage_list").before(
      "<hp-mark class='nosave'></hp-mark>" +
      "<lift class='nosave'></lift>" +
      "<fp-mark class='nosave'></fp-mark>" +
      "<damages class='nosave'>" +
      "<damage-thr class='nosave gc-tool-click'></damage-thr>" +
      "<damage-sw class='nosave gc-tool-click'></damage-sw>" +
      "<damage-punch class='nosave gc-tool-click'></damage-punch>" +
      "<damage-kick class='nosave gc-tool-click'></damage-kick>" +
//          "<damage-kick-boots class='nosave'></damage-kick-boots>" +
      "<separator class='nosave'></separator>" +
      "<dodge class='nosave'></dodge>" +
      "</damages>" +
      "<locations-list class='nosave'>" +
      "<location name='skull'><dr></dr><to-hit>-7</to-hit><roll>3 4</roll></location>" +
      "<location name='face'><dr></dr><to-hit>-5</to-hit><roll>5</roll></location>" +
      "<location name='eyes'><dr></dr><to-hit>-9</to-hit></location>" +
      "<location name='neck'><dr></dr><to-hit>-5</to-hit><roll>17 18</roll></location>" +
      "<location name='torso'><dr></dr><to-hit>0</to-hit><roll>9 10</roll></location>" +
      "<location name='groin'><dr></dr><to-hit>-3</to-hit><roll>11</roll></location>" +
      "<location name='arms'><dr></dr><to-hit>-2</to-hit><roll>п.8<br/>л.12</roll></location>" +
      "<location name='hands'><dr></dr><to-hit>-4</to-hit><roll>15</roll></location>" +
      "<location name='legs'><dr></dr><to-hit>-2</to-hit><roll>п.6 7<br/>л.13 14</roll></location>" +
      "<location name='feet'><dr></dr><to-hit>-4</to-hit><roll>16</roll></location>" +
      "</locations-list>" +
      "<reaction-text class='nosave'></reaction-text>");


    globalChar.find("total_points").addClass('spinner spinner-five editable');
    globalChar.find("earn_points").addClass('spinner editable');
//    globalChar.find("spend_points").addClass('nosave');

    globalChar.find("total_points,spend_points").after(
      "<left_points class='nosave'></left_points>" +
      "<spend_points_details class='nosave'>" +
      " <spend_points_stats class='nosave spend_points_details'></spend_points_stats>" +
      " <spend_points_adv class='nosave spend_points_details'></spend_points_adv>" +
      " <spend_points_disadv class='nosave spend_points_details'></spend_points_disadv>" +
      " <spend_points_quirks class='nosave spend_points_details'></spend_points_quirks>" +
      " <spend_points_skills class='nosave spend_points_details'></spend_points_skills>" +
      " <spend_points_spells class='nosave spend_points_details'></spend_points_spells>" +
      " <spend_points_race class='nosave spend_points_details'></spend_points_race>" +
      "</spend_points_details>"
    );
    globalChar.find("disadvantages_threshold").addClass('spinner spinner-not-positive spinner-five editable');
    globalChar.find("quirks_threshold").addClass('spinner spinner-not-positive editable');


    var toolbar = $("<list_toolbar class='nosave'><font-increment></font-increment> <font-decrement></font-decrement> <description-inline-btn></description-inline-btn> <fold-unfold></fold-unfold> <sort></sort> <container-add></container-add> <item-add></item-add>  <page-cut-btn></page-cut-btn></list_toolbar>");

    globalChar.find("advantage_list,skill_list,spell_list,equipment_list").before(toolbar);
    globalChar.find("character>notes").before("<list_toolbar class='nosave'><page-cut-btn></page-cut-btn></list_toolbar>");

    globalChar.find("list_toolbar").each(function () {
      $(this).addClass($(this).next().prop("tagName").toLowerCase()+"_toolbar");
    })

    globalChar.find("history").before("<list_toolbar class='nosave history_toolbar'><close-btn></close-btn><add-note></add-note> </list_toolbar>");

    // Render

    globalChar.find("advantage_container,skill_container,spell_container,equipment_container").each(function () {
      renderContainer($(this));
    });

    globalChar.find("advantage_list advantage").each(function () {
      renderAdvantage($(this));
    });

    globalChar.find("skill_list skill,skill_list technique").each(function () {
      renderSkill($(this));
    });

    globalChar.find("spell_list spell").each(function () {
      renderSpell($(this));
    });

    globalChar.find("equipment_list equipment").each(function () {
      renderEquipment($(this));
    });


    globalChar.find(">template-fix>notes,>character>notes").addClass("editable");

    globalChar.find("history").children().filter("note").addClass("editable");

    checkEmptyContainers();
    setDrag();
    bindEvents();
  }

  function spinn(obj, steps) {
    var value = $(obj).html();
    var step = 1;


    if ($(obj).hasClass('spinner-decile')) step = 0.1;
    if ($(obj).hasClass('spinner-quarter')) step = 0.25;
    if ($(obj).hasClass('spinner-half')) step = 0.5;
    if ($(obj).hasClass('spinner-control-roll')) step = 3;
    if ($(obj).hasClass('spinner-five')) step = 5;
    value = 1 * value + steps*step;

    if ($(obj).hasClass('spinner-positive') && value < 1) value = 1;
    if ($(obj).hasClass('spinner-not-negative') && value < 0) value = 0;
    if ($(obj).hasClass('spinner-not-positive') && value > 0) value = 0;
    if ($(obj).hasClass('spinner-control-roll') && value < 6) value = 6;
    if ($(obj).hasClass('spinner-control-roll') && value > 15) value = 15;
    value=round(value,3);

    if ($(obj).hasClass('spinner-damage')) {
      if (steps==10) steps="1d";
      if (steps==-10) steps="-1d";
      value=modifyDamage($(obj).html(),steps);
    }

    $(obj).html(value);

    if ($(obj).hasClass('result-reverse')) calcResultReverse($(obj));

    calcAllSchedule();
    saveButtonEnable();
  }

  function fieldChanged(obj){
    if (viewerMode) {
      $(obj).addClass('changed');
      flyAlert('В режиме просмотра изменения не сохраняются',obj);
    }
    setModifyAttr(obj,'changed');
    var tagName = $(obj).prop("tagName");
    if ($(obj).hasClass("spinner")||tagName=='HP_LOST'||tagName=='FP_LOST'||tagName=='DESCRIPTION')
    {
      logIt($(obj),$(obj).html());
    }
  }

  var lastFiledVar="";
  function bindEvents() {
    globalChar.find("portrait-img").unbind("click").bind("click", portraitPopup);

    globalChar.find(".editable").unbind("keyup").bind("keyup", function () {
      if ($(this).hasClass('result-reverse')) calcResultReverse($(this));

      fieldChanged(this);
      undoSave();
      saveButtonEnable();

    });

    globalChar.find("profile>*").not("portrait-img,sm,sm_result,notes,portrait").unbind("focus").bind("focus",showProfilePanel).unbind("blur").bind("blur",hideProfilePanelShedule);
    globalChar.find("profile>name").bind("blur",updateBrowserTitle);

    globalChar.find(".spinner").unbind("keyup").bind("keyup", function () {
      if (event.key == "ArrowUp") {
        spinn($(this), event.ctrlKey?10:1);
        return
      }
      if (event.key == "ArrowDown") {
        spinn($(this), event.ctrlKey?-10:-1);
        return
      }

      var value = ($(this).hasClass('float')) ? $(this).float() : $(this).int();
      if (isNaN(value)) value = 0;
      if ($(this).hasClass('spinner-positive') && value < 1) value = 1;
      if ($(this).hasClass('spinner-not-negative') && value < 0) value = 0;
      if ($(this).hasClass('spinner-not-positive') && value > 0) value = 0;
      if ($(this).hasClass('spinner-control-roll') && value < 6) value = 6;
      if ($(this).hasClass('spinner-control-roll') && value > 15) value = 15;

      if (value != $(this).html()) $(this).html(value);

      if ($(this).hasClass('result-reverse')) calcResultReverse($(this));

      fieldChanged(this);
      calcAllSchedule();
      saveButtonEnable();
    });

    globalChar.find(".spinner").unbind('mousewheel').bind('mousewheel', function (e) {
      if ($(this).is(":focus")) {
        spinn($(this), (event.ctrlKey?10:1)*((e.originalEvent.wheelDelta / 300 > 0)?1:-1));
        event.preventDefault();

        fieldChanged(this);
      }
    }).unbind("focus").bind("focus", function () {
      lastFiledVar=$(this).html();
      showSpinnPanel($(this));
    }).unbind("blur").bind("blur", function () {
      hideSpinnPanelShedule();
    }).unbind("click").bind("click", function () {
      viewHint($(this));
      return false;
    });


    globalChar.find("gc-level").unbind("click").bind("click",function () {makeToolRoll(this)});


    globalChar.find("hp_lost,fp_lost").unbind("keyup").bind("keyup", function () {
      fieldChanged(this);
      calcAllSchedule();
      saveButtonEnable();
    }).unbind("click").bind("click", function () {
      viewHint($(this));
      return false;
    }).unbind("focus").bind("focus", function () {
      lastFiledVar=$(this).html();
    });


    globalChar.find("prereq_list name").unbind("click").bind("click", function () {
      $("lib-filter input").val($(this).html());
      doSearch();
      return false;
    });

    // minimizers
//    globalChar.find("hp_lost").before("<minimizer class='nosave hp_lost_minimizer'></minimizer>");


    globalChar.find(".profile_minimizer").unbind("click").bind("click", function () {
      if ($(this).next().attr("minimized")=="yes"){
        $(this).next().removeAttr("minimized");
        $(this).removeClass("minimized")
      }
      else {
        $(this).next().attr("minimized","yes");
        $(this).addClass("minimized")
      }
      saveButtonEnable();

    });



    // Toolbars

    function listFontChnage(obj,add){
      var size = parseInt(obj.attr("size")) || 0;
      size+=add;
      if (size < -6) size = -6;
      if (size > 0) size = 0;
      obj.attr("size", size);
    }


    globalChar.find("font-increment").unbind("click").bind("click", function () {
      listFontChnage($(this).parent().next(),1);
      saveButtonEnable();
    });


    globalChar.find("font-decrement").unbind("click").bind("click", function () {
      listFontChnage($(this).parent().next(),-1);
      saveButtonEnable();
    });

    globalChar.find("container-add").unbind("click").bind("click", function () {
      var obj = $(this).parent().next();
      var tag = obj[0].tagName.toLocaleLowerCase();
      var add;
      if (tag == "advantage_list") add = $("<advantage_container><name>Группа</name></advantage_container>");
      if (tag == "skill_list") add = $("<skill_container><name>Группа</name></skill_container>");
      if (tag == "spell_list") add = $("<spell_container><name>Группа</name></spell_container>");
      if (tag == "equipment_list") add = $("<equipment_container><description>Группа</description></equipment_container>");
      add.append($(obj).find(".ui-selected"));
      renderContainer(add);
      obj.prepend(add);
      if (templateMode) placeInFirstContainer(add);
      setModifyAttr(add,'changed');
      checkEmptyContainers();
      calcAllSchedule();
      saveButtonEnable();
      setDrag();
      bindEvents();
    });


    globalChar.find("item-add").unbind("click").bind("click", function () {
      var obj = $(this).parent().next();
      var tag = obj[0].tagName.toLocaleLowerCase();
      var editAfterAdd = false;
      var add;
      if (tag == "advantage_list") {
        add = $("<advantage><name>Custom Adv</name>\n<name-loc>Новое название</name-loc>\n<type>-</type>\n<base_points>10</base_points></advantage>");
        renderAdvantage(add);
        editAfterAdd = true;
      }
      if (tag == "skill_list") {
        add = $("<skill><name>Custom skill</name>\n<name-loc>Новое название</name-loc>\n<difficulty>DX/E</difficulty>\n<points>1</points></skill>");
        renderSkill(add);
        editAfterAdd = true;
      }
      if (tag == "spell_list") {
        add = $("<spell><name>Custom Spell</name>\n<name-loc>Новое название</name-loc>\n<college>Collage</college>\n<power_source>Arcane</power_source>\n<spell_class>Regular</spell_class>\n<casting_cost>1</casting_cost>\n<maintenance_cost>1</maintenance_cost>\n<casting_time>1 sec</casting_time>\n<duration>1 sec</duration>\n<points>1</points></spell>");
        renderSpell(add);
        editAfterAdd = true;
      }
      if (tag == "equipment_list") {
        add = $("<equipment>\n<quantity>1</quantity>\n<description></description>\n</equipment>");
        renderEquipment(add);
      }

      $(obj).prepend(add);
      fieldChanged($(add));
      logIt($(add),"add");

      if (templateMode) placeInFirstContainer(add);

      $(add).find("description").focus(); // Для снаряжения - сразу ставим фокус

      if (editAfterAdd) {
        editXML(add, null, function () {
          add.remove();
        });
      } else {
        calcAll();
        setDrag();
        bindEvents();
        saveButtonEnable();
      }
    });

    globalChar.find("page-cut-btn").unbind("click").bind("click", function () {
      if ($(this).parent().prev("page-break").length) $(this).parent().prev("page-break").remove();
      else $(this).parent().before("<page-break/>");
      undoSave();
      saveButtonEnable();
    });

    globalChar.find("description-inline-btn").unbind("click").bind("click", function () {
      $(this).parent().next().toggleClass("show-description-inline");
    });

    globalChar.find("fold-unfold").unbind("click").bind("click", function () {
      var cont=$(this).parent().next().find("advantage_container,skill_container,spell_container,equipment_container");
      if (cont.length){
        var setTo=(cont[0].getAttribute('open')==="no")?'yes':'no';
        cont.each(function(){
          this.setAttribute('open',setTo);
        });
      }
    });

    globalChar.find("sort").unbind("click").bind("click", function () {
      sortList($(this).parent().next())
    });

    globalChar.find(".history_toolbar close-btn").unbind("click").bind("click", function () {
      $('body').removeClass('show-history');
    });
    globalChar.find(".history_toolbar add-note").unbind("click").bind("click", function () {
      modalPopup("<h3>Добавить заметку</h3><input type='text' id='note-text' style='width:100%;'>", "Добавить", "Отмена", function () {
        if ($("#note-text").val()!=""){
          globalHistory.append("<note class='editable' date='" + (new Date()).getTime() + "'>" + $("#note-text").val() +
            "</note>");
          historyScrollDown();
          saveButtonEnable();
        }
      }, null, function () {
        $("#note-text").focus();
      });
    });
    globalChar.find("history").unbind("click").bind("click", function () {
      var obj = $(event.target).parents().andSelf().filter("event,note");
      if (obj.length) showFloatPanel(obj,"history")
    });
  }

  function sortList(obj){

    var isAdv=($(obj).find("advantage").length>0);
    var isSkill=($(obj).find("skill,technique").length>0);
    var isSpell=($(obj).find("spell").length>0);
    var isEquipment=($(obj).find("equipment").length>0);


    modalPopup("<h4>Сортировать по</h4> <div style='text-align:left; max-width:250px; margin:0 auto;'>" +
      (!isEquipment?"<p><label><input type='radio' name='sortBy' value='name' checked> Названию английскому</label></p>":"") +
      (!isEquipment?"<p><label><input type='radio' name='sortBy' value='name-loc'> Названию русскому</label></p>":"") +
      (isEquipment?"<p><label><input type='radio' name='sortBy' value='description' checked> Названию</label></p>":"") +
      (!isEquipment?"<p><label><input type='radio' name='sortBy' value='gc-cost,points,gc-container-cost'> Очкам</label></p>":"") +
      (isSkill||isSpell?"<p><label><input type='radio' name='sortBy' value='gc-level'> Уровню</label></p>":"") +
      (isSkill?"<p><label><input type='radio' name='sortBy' value='gc-stat'> Стату</label></p>":"") +
      (isSpell?"<p><label><input type='radio' name='sortBy' value='college'> Школе маги</label></p>":"") +
      (isSpell?"<p><label><input type='radio' name='sortBy' value='spell_class'> Классу заклинания</label></p>":"") +
      (isSpell?"<p><label><input type='radio' name='sortBy' value='casting_cost'> Цене сотворения</label></p>":"") +
      (isEquipment?"<p><label><input type='radio' name='sortBy' value='price'> Цене</label></p>":"") +
      (isEquipment?"<p><label><input type='radio' name='sortBy' value='weight'> Весу</label></p>":"") +
      (isEquipment?"<p><label><input type='radio' name='sortBy' value='quantity'> Количеству</label></p>":"") +
      "<hr>" +
      "<p class='note'><label><input type='checkbox' name='sortСontainersUp'> Контейнеры вверх</label></p>" +
      "<p class='note'><label><input type='checkbox' name='sortDesc'> В обратную сторону</label></p>" +
      "<p class='note'><label><input type='checkbox' name='sortRecursive'> Сортировать внутри всех групп тоже</label></p>" +
      "</div>",
      "Сортировать","Отмена",function () {
        var sortBy=$("modalpopup input[name='sortBy']:checked").val();
        var sortDesc=$("modalpopup input[name='sortDesc']:checked").val();
        var sortСontainersUp=$("modalpopup input[name='sortСontainersUp']:checked").val();
        doSort(obj,sortBy,sortDesc,sortСontainersUp);
        if ($("modalpopup input[name='sortRecursive']").is(':checked')){
          $(obj.find("advantage_container,skill_container,spell_container,equipment_container")).each(function (){
            doSort($(this),sortBy,sortDesc,sortСontainersUp);
          });
        }
        saveButtonEnable();


      });
    function doSort(obj,sortBy,sortDesc,sortСontainersUp){
      var list=obj.find(">advantage,>skill,>technique,>spell,>equipment,>advantage_container,>skill_container,>spell_container,>equipment_container");
      list.sort(function(a,b){

        var ac=($(a).prop("tagName").indexOf("_CONTAINER")>0);
        var bc=($(b).prop("tagName").indexOf("_CONTAINER")>0);

        if (sortСontainersUp&&ac&&!bc) return -1;
        if (sortСontainersUp&&!ac&&bc) return 1;

        if (sortСontainersUp&&ac&&bc) {
          var as=$(a).find(">name").html();
          var bs=$(b).find(">name").html();
        }else if (sortBy=="name"||sortBy=="name-loc"||sortBy=="college"||sortBy=="description")
        {
          var as=$(a).find(">"+sortBy).html();
          var bs=$(b).find(">"+sortBy).html();
          if (ac) as=$(a).find(">name").html(); // контейнеры
          if (bc) bs=$(b).find(">name").html(); // контейнеры

        } else if (sortBy=="gc-stat") {
          var as=($(a).find(">"+sortBy).html()||"").charAt(0);
          var bs=($(b).find(">"+sortBy).html()||"").charAt(0);
        } else {
          var as=$(a).find(">"+sortBy).int();
          var bs=$(b).find(">"+sortBy).int();
        }

        if(as < bs) return sortDesc?1:-1;
        else if(as > bs) return sortDesc?-1:1;
        else return 0;
      });
      list.detach().appendTo(obj);
    }
  }




  var calcTimeut;
  function calcAllSchedule() {
    if ($("body").hasClass("manual-calc-mode")){
      $("manual-calc").removeClass("disabled");
    }
    else {
      clearTimeout(calcTimeut);
      calcTimeut = setTimeout(calcAll, 200);
    }
  }

  function calcResultReverse(obj) {

    var tag = obj.prop("tagName");
    if (tag == "ST_RESULT")
      globalChar.find("ST").html(globalChar.find("ST_result").html() - globalChar.find("ST_bonus").int());
    else if (tag == "DX_RESULT")
      globalChar.find("DX").html(globalChar.find("DX_result").html() - globalChar.find("DX_bonus").int());
    else if (tag == "IQ_RESULT")
      globalChar.find("IQ").html(globalChar.find("IQ_result").html() - globalChar.find("IQ_bonus").int());
    else if (tag == "HT_RESULT")
      globalChar.find("HT").html(globalChar.find("HT_result").html() - globalChar.find("HT_bonus").int());
    else if (tag == "HP_RESULT")
      globalChar.find("HP").html(globalChar.find("HP_result").html() - globalChar.find("HP_bonus").int() - getAttr('ST'));
    else if (tag == "FP_RESULT")
      globalChar.find("FP").html(globalChar.find("FP_result").html() - globalChar.find("FP_bonus").int() - getAttr('HT'));
    else if (tag == "WILL_RESULT")
      globalChar.find("WILL").html(globalChar.find("WILL_result").html() - globalChar.find("WILL_bonus").int() - (isCharOption("will-free")?10:getAttr('IQ')));
    else if (tag == "PERCEPTION_RESULT")
      globalChar.find("PERCEPTION").html(globalChar.find("PERCEPTION_result").html() - globalChar.find("PERCEPTION_bonus").int() - (isCharOption("will-free")?10:getAttr('IQ')));
    else if (tag == "SPEED_RESULT")
      globalChar.find("SPEED").html(globalChar.find("SPEED_result").html() - globalChar.find("SPEED_bonus").html() - (1 * getAttr('HT') + 1 * getAttr('DX')) / 4);
    else if (tag == "MOVE_RESULT")
      globalChar.find("MOVE").html(globalChar.find("MOVE_result").html() - globalChar.find("MOVE_bonus").html() - Math.floor(globalChar.find("SPEED_result").html()));
    else if (tag == "SM_RESULT")
      globalChar.find("SM").html(globalChar.find("SM_result").html() - globalChar.find("SM_bonus").int());
    else if (tag == "WEIGHT-KG") $(obj).parent().find("WEIGHT").html(($(obj).html()*2)||"");

  }

  function calcAll(force,calcBaseOnly) {
    if (!force&&$("body").hasClass("manual-calc-mode")){
      $("manual-calc").removeClass("disabled");
      return;
    }


    var calcStartTime = new Date().getTime();

    updateGlobalLists(); // Links to global lists


    globalChar.find(".bonus").text(0); // обнуляем все бонусы
    globalChar.find(".cost-modifier").text(1); // обнуляем все модификаторы
    globalChar.find("reaction-text").html("");

    globalModifiersOn.each(function () {
      var bonus = 0;
      $(this).find(">attribute_bonus").each(function () {
        if ($(this).find("amount").attr("per_level") == "yes") {
          bonus = 1 * $(this).find("amount").html() * ($(this).parent().find(">levels").float()||$(this).parent().parent().find(">levels").float()||0);
        } else {
          bonus = 1 * $(this).find("amount").html();
        }
        var attr = $(this).find("attribute").text();
        if ($(this).find("attribute").attr("limitation")=="lifting only") attr+="_lift";
        if ($(this).find("attribute").attr("limitation")=="striking only") attr+="_strike";
        if (attr=="taste smell") attr="taste_smell";
        if (attr=="fright check") attr="fright_check";

        if (attr=="air move") attr="air_move";
        if (attr=="ground move") attr="ground_move";
        if (attr=="space move") attr="space_move";
        if (attr=="water move") attr="water_move";

        if (attr == "reaction") {
          var name=$(this).parents("advantage,skill,technique,spell,equipment,equipment_container").find(">name,>description").html();
          var limitation=$(this).find(">limitation").text();
          if (limitation=="") {
            globalChar.find("reaction-text").append("<reaction>"+(bonus>0?"+":"")+bonus+" от "+name+"</reaction>");
          }
          else{
            globalChar.find("reaction-text").append("<limitation>"+limitation+": "+(bonus>0?"+":"")+bonus+" от "+name+"</limitation>");
            return; // что не считать в общий аджастмент
          }
        }

        var bonusField = globalChar.find(attr + "_bonus");
        bonusField.html(bonusField.float() + bonus);
      });

      $(this).find(">cost_reduction").each(function () {
        var attr = $(this).find("attribute").html();
        var curr = globalChar.find(attr + "_cost_modifier").float();
        curr = curr - 0.01 * $(this).find("percentage").int();
        globalChar.find(attr + "_cost_modifier").html(curr);
      });
    });
    if (globalChar.find("reaction-text").html()!="") globalChar.find("reaction-text reaction").last().after("<total>"+(globalChar.find("reaction_bonus").int()>0?"+":"")+globalChar.find("reaction_bonus").int()+"</total>");
    globalChar.find("reaction-text limitation").appendTo(globalChar.find("reaction-text"));

    globalChar.find("SM_result").html(globalChar.find("SM").int() + globalChar.find("SM_bonus").int()); // Надо считаь до цены ST и HP ибо влияет
    { // size modifier on cost
      var sm = globalChar.find("SM_result").int();
      if (sm < 0) sm = 0;
      if (sm > 8) sm = 8;
      globalChar.find("ST_cost_modifier").html(globalChar.find("ST_cost_modifier").float() - 0.1 * sm)
      globalChar.find("HP_cost_modifier").html(globalChar.find("HP_cost_modifier").float() - 0.1 * sm)
    }

    // Режем модификатор до минимуму в 20%
    globalChar.find(".cost-modifier").each(function () {
      if ($(this).float() < 0.2) $(this).html("0.2");
    });


    $.each(["ST", "DX", "IQ", "HT"], function (i, stat) {
      globalChar.find(stat + "_result").next('gc-cost').html(getAttrCost(stat, globalChar.find(stat).int()));
      globalChar.find(stat + "_result").setHtmlIfChanged(globalChar.find(stat).int() + globalChar.find(stat + "_bonus").int());

    });

    globalChar.find(".HP_cost").html(Math.round(globalChar.find("HP").html() * 2 * globalChar.find("HP_cost_modifier").float()));
    globalChar.find("HP_result").setHtmlIfChanged(1 * getAttr('ST') + globalChar.find("HP").int() + globalChar.find("HP_bonus").int());
    var toHeight = (Math.abs(globalChar.find("HP").html()) / getAttr('ST') > 0.3);
    globalChar.find("HP_result").lightStatus("gc-warning", toHeight);

    globalChar.find(".FP_cost").html(globalChar.find("FP").html() * 3);
    globalChar.find("FP_result").setHtmlIfChanged(1 * getAttr('HT') + globalChar.find("FP").int() + globalChar.find("FP_bonus").int());
    var toHeight = (Math.abs(globalChar.find("FP").html()) / getAttr('HT') > 0.3);
    globalChar.find("FP_result").lightStatus("gc-warning", toHeight);


    globalChar.find(".WILL_cost").html(globalChar.find("WILL").html() * 5);
    globalChar.find("WILL_result").setHtmlIfChanged(1 * (isCharOption("will-free")?10:getAttr('IQ')) + globalChar.find("WILL").int() + globalChar.find("WILL_bonus").int());
    var toHeight = (globalChar.find("WILL_result").html() > 20 || globalChar.find("WILL_result").html() < 4);
    globalChar.find("WILL_result").lightStatus("gc-warning", toHeight);

    var fearTexts="";
    if (globalChar.find("fright_check_bonus").int()!=0) fearTexts="Страх "+(globalChar.find("WILL_result").int()+globalChar.find("fright_check_bonus").int());
    globalChar.find("WILL_add").html(fearTexts);


    globalChar.find(".PERCEPTION_cost").html(globalChar.find("PERCEPTION").html() * 5);
    globalChar.find("PERCEPTION_result").setHtmlIfChanged(1 * (isCharOption("will-free")?10:getAttr('IQ')) + globalChar.find("PERCEPTION").int() + globalChar.find("PERCEPTION_bonus").int());
    var toHeight = (globalChar.find("PERCEPTION_result").html() > 20 || globalChar.find("PERCEPTION_result").html() < 4);
    globalChar.find("PERCEPTION_result").lightStatus("gc-warning", toHeight);

    var perceptonTexts="";
    var perceptonBase=globalChar.find("PERCEPTION_result").int();
    if (globalChar.find("hearing_bonus").int()!=0) perceptonTexts+="Слух "+(perceptonBase+globalChar.find("hearing_bonus").int())+"<br>";
    if (globalChar.find("taste_smell_bonus").int()!=0) perceptonTexts+="Нюх "+(perceptonBase+globalChar.find("taste_smell_bonus").int())+"<br>";
    if (globalChar.find("touch_bonus").int()!=0) perceptonTexts+="Осяз "+(perceptonBase+globalChar.find("touch_bonus").int())+"<br>";
    if (globalChar.find("vision_bonus").int()!=0) perceptonTexts+="Зрен "+(perceptonBase+globalChar.find("vision_bonus").int())+"<br>";
    globalChar.find("PERCEPTION_add").html(perceptonTexts);

    globalChar.find(".SPEED_cost").html(globalChar.find("SPEED").html() * 20);
    globalChar.find("SPEED_result").setHtmlIfChanged((1 * getAttr('HT') + 1 * getAttr('DX')) / 4 + 1 * globalChar.find("SPEED").html() + 1 * globalChar.find("SPEED_bonus").html());
    var toHeight = (Math.abs(globalChar.find("SPEED").html()) > 2);
    globalChar.find("SPEED_result").lightStatus("gc-warning", toHeight);


    globalChar.find(".MOVE_cost").html(globalChar.find("MOVE").html() * 5);
    globalChar.find("MOVE_result").setHtmlIfChanged(Math.floor(Math.floor(globalChar.find("SPEED_result").float()) + 1 * globalChar.find("MOVE").int() + globalChar.find("MOVE_bonus").int()));
    var toHeight = (Math.abs(globalChar.find("MOVE").html()) > 3);
    globalChar.find("MOVE_result").lightStatus("gc-warning", toHeight);



    var basicLift = getBasicLift(1*getAttr('ST')+globalChar.find("ST_lift_bonus").int());
    globalChar.find("lift").html(
      "<item modifier='0'><name>Нет (0)</name><lbs>" + round(basicLift, 1) + "</lbs><kg>" + round(basicLift * 0.5, 1) + "</kg></item>" +
      "<item modifier='-1'><name>Легкая(-1)</name><lbs>" + round(basicLift * 2, 1) + "</lbs><kg>" + round(basicLift, 1) + "</kg></item>" +
      "<item modifier='-2'><name>Средняя(-2)</name><lbs>" + round(basicLift * 3, 1) + "</lbs><kg>" + round(basicLift * 1.5, 1) + "</kg></item>" +
      "<item modifier='-3'><name>Тяжелая(-3)</name><lbs>" + round(basicLift * 6, 1) + "</lbs><kg>" + round(basicLift * 3, 1) + "</kg></item>" +
      "<item modifier='-4'><name>Сверх(-4)</name><lbs>" + round(basicLift * 10, 1) + "</lbs><kg>" + round(basicLift * 5, 1) + "</kg></item>"
    );

    // HP


    globalChar.find("hp-mark").html(
      "<num class='hp-low'>" + Math.ceil(2 * getAttr('HP_result') / 3+0.001) + "</num><label>Измотан 1/2 move, 1/2 dodge</label>" +
      "<num>" + getAttr('HP_result') + "</num><label>Без сознания (HT - death lev) каждый ход</label>" +
      "<num>" + (2 * getAttr('HP_result')) + "</num><label>1й бросок от смерти</label> " +
      "<num>" + (3 * getAttr('HP_result')) + "</num><label>2й бросок от смерти</label> " +
      "<num>" + (4 * getAttr('HP_result')) + "</num><label>3й бросок от смерти</label> " +
      "<num>" + (5 * getAttr('HP_result')) + "</num><label>4й бросок от смерти</label> " +
      "<num>" + (6 * getAttr('HP_result')) + "</num><label>Смерть"
    );

    // HP lost
    {
      var lostStr=globalChar.find("hp_lost").text()
      var lostNum=tryCalculateString(lostStr);
      globalChar.find("hp_lost").attr("total", (lostNum==""||lostNum==lostStr)?"":"="+lostNum);
      globalChar.find("hp-mark num").each(function () {
        $(this).lightStatus("gc-warning", ($(this).int() <= lostNum));
      });
    }

    // FP

    globalChar.find("fp-mark").html(
      "<num class='fp-low'>" + Math.ceil(2 * getAttr('FP_result') / 3+0.001) + "</num><label>Устал: 1/2 move, 1/2 dodge, 1/2 ST</label>" +
      "<num>" + getAttr('FP_result') + "</num><label>Потеря HP<br/>(бросок воли на любое действие)</label>" +
      "<num>" + (2 * getAttr('FP_result')) + "</num><label>Потеря сознания</label> "
    );

    // FP lost
    {
      var lostStr=globalChar.find("fp_lost").text()
      var lostNum=tryCalculateString(lostStr);
      globalChar.find("fp_lost").attr("total", (lostNum==""||lostNum==lostStr)?"":"="+lostNum);
      globalChar.find("fp-mark num").each(function () {
        $(this).lightStatus("gc-warning", ($(this).int() <= lostNum));
      });
    }


    // При малой калькуляции - прекратить не считаем все что требует опроса всех объектов
    if (calcBaseOnly) return;



    // Вес
    {
      // Считаем вес и деньги контейнеров
      globalChar.find("equipment_container").each(function () {
        normalizeEquipmentMeasures(this);
        var toKg=(globalChar.find("character,template-fix").attr('measure')=='kg');
        var kefficient=(toKg)?0.5:1;
        var containerWeitgh = 0;
        var containerValue = 0;
        $(this).find("equipment,equipment_container").each(function () {
          containerWeitgh += getEquipmentWeight($(this));
          containerValue +=getEquipmentValue($(this))
        });
        containerWeitgh = round(containerWeitgh * kefficient,2);
        if (containerWeitgh == 0) containerWeitgh = "";

        containerValue = round(containerValue,2);
        if (containerValue == 0) containerValue = "";
        else containerValue="$"+containerValue+", ";



        var selfWeitgh = getEquipmentWeight(this);
        if (selfWeitgh > 0) containerWeitgh = round(selfWeitgh * kefficient,2) + (containerWeitgh>0? ("+" + containerWeitgh):"");
        $(this).find("gc-container-weight").html(containerValue+containerWeitgh+(toKg?" кг":" lb"));
      });

      // Считаем общий вес и цену
      var totalWeight = 0;
      var totalWeightNotCarried = 0;
      var totalValue = 0;
      globalChar.find("equipment,equipment_container").each(function () {
        if ($(this).attr("state") == "not carried") totalWeightNotCarried += 1*getEquipmentWeight($(this));
        else totalWeight += 1*getEquipmentWeight($(this));
        totalValue += 1*getEquipmentValue($(this));
      });
      totalWeight = round(totalWeight,2)
      totalWeightNotCarried = round(totalWeightNotCarried,2);
      totalValue = round(totalValue,2);

      var toKg=(globalChar.find("character,template-fix").attr('measure')=='kg');
      var kefficient=(toKg)?0.5:1;
      globalChar.find("equipment_list").attr("total-weight", ((totalWeight == 0) ? "" : '  ' + totalWeight*kefficient + (toKg?" кг":" lb")) + ((totalWeightNotCarried == 0) ? "" : ' не с собой: ' + totalWeightNotCarried*kefficient + (toKg?" кг":" lb")) + ((totalValue == 0) ? "" : '  $' + totalValue));

      var prevLift = 0;
      globalChar.find("lift item lbs").each(function () {
        $(this).prev("name").lightStatus('gc-warning', prevLift < totalWeight)
        if (prevLift < totalWeight) {
          globalChar.find("encumbrance_bonus").html($(this).parent().attr("modifier"));
          globalChar.find("lift item").removeClass("current-lift");
          $(this).parent().addClass("current-lift");
        }
        prevLift = $(this).float();
      });


      var moveText="";
      var moveBase=globalChar.find("move_result").int();
      var movieModified=moveModifiedByAll();
      if (moveBase!=movieModified) moveText+="<span class='gc-warning'>Сейчас "+movieModified+"</span><br>";

      if (globalChar.find("air_move_bonus").float()!=0) moveText+="Полет "+Math.round(moveBase*Math.pow(2,globalChar.find("air_move_bonus").float()))+"<br>";
      if (globalChar.find("ground_move_bonus").float()!=0) moveText+="Назем. "+Math.round(moveBase*Math.pow(2,globalChar.find("ground_move_bonus").float()))+"<br>";
      if (globalChar.find("space_move_bonus").float()!=0) moveText+="Космос "+Math.round(moveBase*Math.pow(2,globalChar.find("space_move_bonus").float()))+"<br>";
      if (globalChar.find("water_move_bonus").float()!=0) moveText+="Вода "+Math.round(moveBase*Math.pow(2,globalChar.find("water_move_bonus").float()))+"<br>";

      globalChar.find("move_add").html(moveText);

      globalChar.find("st_add").html(globalChar.find(".fp-low.gc-warning").length?(Math.ceil(getAttr("ST")/2)):"");
      //globalChar.find("st_add").html("30");
    }


    globalAdvantagesList.each(function () {
      calcAdvantage($(this));
    });
    globalSkillsList.each(function () {
      calcSkill($(this));
    });
    globalSpellsList.each(function () {
      calcSpell($(this));
    });
    globalTechniqueList.each(function () {
      // Объязательно после скилов и спелов!!!
      calcSkill($(this));
    });

    globalEquipmentList.each(function () {
      calcEquipment($(this));
    });


    globalAllList.each(function () {
      $(this).lightStatus("prereq-fail", !checkPrerequisits($(this)));
    });
    // Считаем контейнеры
    globalChar.find("advantage_container,skill_container,spell_container").each(function () {
      var containerCost = 0;
      $(this).find("gc-cost, skill>points, technique>points, spell>points").each(function () {
        containerCost += $(this).int()||0;
      });
      if ($(this).attr('type')=='alternative abilities'&&containerCost<0) containerCost=0;
      $(this).find("gc-container-cost").html(containerCost);
    });

    // считаме damage pary dodge

    var strikingST=1*getAttr('ST')+globalChar.find("ST_strike_bonus").int();

    globalChar.find("damages damage-thr").html(getThr(strikingST));
    globalChar.find("damages damage-sw").html(getSw(strikingST));
    globalChar.find("damages damage-punch").html(modifyDamage(getThr(strikingST), -1));
    globalChar.find("damages damage-kick").html(getThr(strikingST));

    var encumbranceBonus=globalChar.find("encumbrance_bonus").int();
    var lowFp=(globalChar.find(".fp-low.gc-warning").length);
    var lowHp=(globalChar.find(".hp-low.gc-warning").length);
    var dodge = Math.floor(getAttr('SPEED_result')) + 3 + globalChar.find("dodge_bonus").int()+encumbranceBonus;
    if (lowFp) dodge*=0.5;
    if (lowHp) dodge*=0.5;
    dodge = (dodge < 1) ? 1 : Math.floor(dodge);
    dodge = "<val class='gc-tool-click'>"+dodge+"</val>";

    if (encumbranceBonus!=0) dodge+="<dodge-tmp-modifier>нагрузка "+encumbranceBonus+"</dodge-tmp-modifier>";
    if (lowHp) dodge+="<dodge-tmp-modifier>1/2 за раны</note>";
    if (lowFp) dodge+="<dodge-tmp-modifier>1/2 - устал</note>";


    globalChar.find("damages dodge").html(dodge);

    globalChar.find("damages parry,damages block").remove();


    globalSkillsAndTechniqueList.find("parry").each(function () {
      var obj = $(this).parent();
      if ($(obj).find(">points").int() > 0) {
        var add = ($(this).attr("after-attack") == "no") ? "<no-parry-after-attack class='nosave'></no-parry-after-attack>" : "";
        globalChar.find("damages dodge").before("<parry class='nosave'><note>Parry " + $(obj).find("name-loc").html() + "</note><val class='gc-tool-click'>" + (Math.floor($(obj).find("gc-level").int() / 2) + 3 + $(this).int() + globalChar.find("parry_bonus").int()) + "</val>" + add + "</parry>");
      }
    });
    globalSkillsAndTechniqueList.find("block").each(function () {
      var obj = $(this).parent();
      if ($(obj).find(">points").int() > 0) {
        globalChar.find("damages dodge").before("<block class='nosave'><note>Block " + $(obj).find("name-loc").html() + "</note><val class='gc-tool-click'>" + (Math.floor($(obj).find("gc-level").int() / 2) + 3 + $(this).int() + globalChar.find("block_bonus").int()) + "</val></block>");
      }
    });

    var weaponBonus={};
    globalSkillsAndTechniqueList.find("weapon_bonus").each(function () {
      // Тупо рпедполагаем что там всегда DX
      var lev=parseInt($(this).parent().find(">gc-stat").text().substr(2))||0;
      if ($(this).parent().find(">gc-stat").text().substr(0,2)!='DX') lev=undefined;

      if (lev>=$(this).find("level").int()) {
        weaponBonus[$(this).find("name").text()]=$(this).find("amount").int()+(weaponBonus[$(this).find("name").text()]||0);
      }
    });

    var dicesPunch=getBaseDice(globalChar.find("damages damage-punch").html());
    var dicesKick=getBaseDice(globalChar.find("damages damage-kick").html());
    $.each(weaponBonus, function( k, v ) {
      globalChar.find("damages damage-punch").append("<weapon-bonus>"+k+" <ammount>+"+v*dicesPunch+"</ammount></weapon-bonus>");
      globalChar.find("damages damage-kick").append("<weapon-bonus>"+k+" <ammount>+"+v*dicesKick+"</ammount></weapon-bonus>");
    });


    // Считаем Итого
    var totalCost = 0;
    var totalStats = 0, totalAdv = 0, totalDisadv = 0, totalQuirks = 0, totalSkills = 0, totalSpells = 0, totalRace= 0;
    globalChar.find("gc-cost, skill>points, technique>points, spell>points").each(function () {

      if ($(this).parents("advantage_container[type]").length) {
        return // Это специальный контейнер - ненадо считать
      }

      var currentPoints=$(this).int()||0

      totalCost+= currentPoints;

      //var tag=$(this)[0].tagName.toLowerCase();
      if ($(this).hasClass('attr_cost') || $(this).hasClass('second_attr_cost')) totalStats += currentPoints;
      if ($(this).parents("skill_list").length) totalSkills += currentPoints;
      if ($(this).parents("spell_list").length) totalSpells += currentPoints;
      if ($(this).parents("advantage_list").length) {
        if ($(this).parent().find("category:contains('Quirk')").length) totalQuirks += currentPoints;
        else if (currentPoints < 0) totalDisadv += currentPoints;
        else totalAdv += currentPoints;
      }
    });

    globalChar.find("advantage_container[type]").each(function (){
      if ($(this).parents("advantage_container[type]").length) {
        return // ненадо считать вложеные контейнеры!
      }
      var cost=$(this).find(">gc-container-cost").int();
      totalCost+=cost;
      if ($(this).attr("type")=='race') {
        totalRace+=cost;
      } else {
        if (cost < 0) totalDisadv += cost;
        else totalAdv += cost;
      }

    });

    var totalPoints=globalChar.find("total_points").int()+globalChar.find("earn_points").int()

    var totalLeft=totalPoints - totalCost;
    if (isNaN(totalLeft)) totalLeft="---";
    globalChar.find("left_points").text(totalLeft);
    globalChar.find("spend_points").text(totalCost);
    globalChar.find("spend_points_stats").text(totalStats);
    globalChar.find("spend_points_adv").text(totalAdv);
    globalChar.find("spend_points_disadv").text(totalDisadv);
    globalChar.find("spend_points_quirks").text(totalQuirks);
    globalChar.find("spend_points_skills").text(totalSkills);
    globalChar.find("spend_points_spells").text(totalSpells);
    globalChar.find("spend_points_race").text(totalRace);
    globalChar.find("left_points").lightStatus("gc-ok", (totalPoints == totalCost));
    globalChar.find("left_points").lightStatus("gc-warning", (totalPoints < totalCost));

    var disadvantagesThreshold = globalChar.find("disadvantages_threshold").int() || -40;
    globalChar.find("spend_points_disadv").lightStatus("gc-warning", (globalChar.find("spend_points_disadv").int() < disadvantagesThreshold ));

    var quirksThreshold = globalChar.find("quirks_threshold").int() || -5;
    globalChar.find("spend_points_quirks").lightStatus("gc-warning", (globalChar.find("spend_points_quirks").int() < quirksThreshold ));


    // Оружие

    var st=getAttr('ST');
    globalChar.find("strength").each(function (){
      $(this).removeClass('gc-warning').removeClass('gc-info');
      if ($(this).text().indexOf("M")>0) return;
      if ($(this).text().indexOf("B")>0) {
        // если есть турель
        if (Math.ceil($(this).int()*2/3)>st)  $(this).addClass('gc-warning');
        else if ($(this).int()>st) $(this).addClass('gc-info');

      }
      else if ($(this).int()>st) {
        $(this).addClass('gc-warning');
      }
    })

    $(globalChar).find(".gc-modified-value").remove();
    $(globalChar).find(".gc-source-value").removeClass("gc-source-value");


    // Скилы для оружия
    globalChar.find("ranged_weapon,melee_weapon,dr_bonus,transport").each(function () {
      var bestDefault=getBestDefault($(this),true);

      var modifier=$(this).find("handling").int()|0;
      if (modifier!=0) {
        bestDefault.bestDefaultText+=" мод"+((modifier>0)?"+":"")+modifier;
        bestDefault.bestDefaultLevel+=modifier;
      }

      if (bestDefault.bestDefaultLevel<0) bestDefault.bestDefaultLevel="";

      $(this).find("gc-level").html(bestDefault.bestDefaultLevel);
      $(this).find("gc-default").html(bestDefault.bestDefaultText).prop("title","Умения:\n"+bestDefault.defaultsListText);

      $(this).find("damage-result, range-result").remove();

      // демедж за левел адвантаги
      var levels=$(this).parent().find(">levels").int();
      $(this).find("*[level_mod='yes']").each(function (){
//        var text=(levels>1)?(levels+"×"+$(this).html()):$(this).html();

        $(this).addClass("gc-source-value");
        var tag=$(this).prop("tagName").toLowerCase();

        var newVal=modifyField($(this).text(),levels,(tag=="damage")?"damage dice multiply":"multiply");
        $(this).after("<"+tag+" class='nosave gc-modified-value'>"+newVal+"</"+tag+">")
      });
    })

    // Модификаторы оружия
    $(globalChar).find("equipment_modifier>*").each(function () {
      if ($(this).parent().parent().attr("state")=='not carried'||$(this).parent().parent().attr("state")=='carried'||$(this).parent().parent().attr("enabled")=='no'){
        $(this).removeClass("gc-warning");
        return;
      }
      var mod=$(this);
      var tag=$(this)[0].tagName;
      var source=$(this).parent().parent().parent("equipment_container,advantage").find(">ranged_weapon,>melee_weapon,>transport");
      if (mod.attr("type")=="create") source.append("<"+tag+" class='nosave gc-modified-value'>"+mod.text()+"</"+tag+">");
      var target=source.find(">"+tag);

      if (tag=="SKILL_LEVEL"){
        target=$(this).parent().parent().parent("equipment_container").find(">*>gc-level");
        mod.lightStatus("gc-warning",target.length==0);
        target.each(function(){
          $(this).html(modifyFieldByTag($(this).text(),mod));
        });
      } else if (tag=="VALUE"){
        mod.lightStatus("gc-warning",$(this).parent().parent().parent("equipment_container").length==0);
      }
      else{
        mod.lightStatus("gc-warning",target.length==0);
        target.each(function(){
          if (!$(this).hasClass("gc-source-value")) {
            $(this).addClass("gc-source-value");
            var result=modifyFieldByTag($(this).text(),mod)
            var newObj=$(this).after("<"+tag+" class='nosave gc-modified-value'>"+result+"</"+tag+">");
          }
        });
      }
    });

    // Добавляем Sw и Thr а так-же Range x
    globalChar.find("ranged_weapon,melee_weapon,dr_bonus,transport").each(function () {

      var selfStrength = ($(this).find("self_strength").int());
      $(this).find("damage").not(".gc-source-value").each(function () {

        var d_parsed=$(this).text().match(/(thr|sw)( ){0,10}((\+|\-)[0-9]{1,2}){0,1}(( ){0,10}(:)((\+|\-)[0-9]{1,2})){0,1}(.*)/);

        if (d_parsed!==null){
          var mod=d_parsed[1];
          var damageMod=parseInt(d_parsed[3])||0;
          var perDice=parseInt(d_parsed[8]||0);
          var endOfDamage=d_parsed[10];

          var baseDmg = "";
          if (selfStrength > 0) baseDmg = (mod == "sw") ? getSw(selfStrength) : getThr(selfStrength);
          else baseDmg = globalChar.find("damages damage-" + mod).text();

          baseDmg=modifyDamage(baseDmg, perDice,true);
          baseDmg=modifyDamage(baseDmg, damageMod);


          $(this).after("<damage-result class='nosave' level_mod='" + $(this).attr('level_mod') + "'>" + baseDmg + " " +endOfDamage + "</damage-result>");
        }



/*        var baseDmg = "";
        var damageMod = "";
        var curObj = $(this);
        ["thr", "sw"].map(function (mod) {
          var offfset = curObj.text().indexOf(mod);
          if (offfset >= 0) {
            if (selfStrength > 0) baseDmg = (mod == "sw") ? getSw(selfStrength) : getThr(selfStrength);
            else baseDmg = globalChar.find("damages damage-" + mod).text();

            var endOfDamage = curObj.text().substr(curObj.text().indexOf(" "));
            var perDie=false;
            damageMod = curObj.text().substr(offfset + mod.length);
            if (damageMod[0]==":") {damageMod=damageMod.substr(1); perDie=true;}
            damageMod = parseInt(damageMod) || 0;
            curObj.after("<damage-result class='nosave' level_mod='" + curObj.attr('level_mod') + "'>" + modifyDamage(baseDmg, damageMod,perDie) + endOfDamage + "</damage-result>");
          }
        })*/
      });

      var weaponSt = (selfStrength > 0) ? selfStrength : getAttr('st');
      $(this).find("range").not(".gc-source-value").each(function () {
        if ($(this).text()[0] == 'x') {
          var spl = $(this).text().split('/');
          $(this).after("<range-result class='nosave'>" + round((spl[0]||"").substr(1) * weaponSt) + "/" + round((spl[1]||"").substr(1) * weaponSt) + "</range-result>");
        }

      });
    });

    globalChar.find("damage,damage-result").addClass("gc-tool-click");
    globalChar.find(".gc-tool-click").unbind("click").bind("click",function () {makeToolRoll(this)});

    // DR
    function drSumm(a,b) {
      // Архаизм с записью брони через дробь можно бурать в последствии
      var x=(a+"").split("/");
      var y=(b+"").split("/");
      if (x[1]==undefined) x[1]=x[0];
      if (y[1]==undefined) y[1]=y[0];
      x[0]=parseInt(x[0])+parseInt(y[0]);
      x[1]=parseInt(x[1])+parseInt(y[1]);

      if (x[0]==x[1]) return (x[0]);
      return (x[0]+"/"+x[1]);
    }
    function drSummObj(res,src){

      function getObjByTypeOrCreate(inObj,typeName){
        var obj=$(inObj).find(">dr[type='"+typeName+"']");
        if (obj.length == 0) {
          obj = $("<dr type='" + typeName + "'>"+inObj.find(">dr:first").html()+"</dr>");
          $(inObj).find(">dr:first").after(obj);
        }
        return obj;
      }

      if ($(src)[0].tagName=="LOCATION"){
        // если суммируем с существующим объетом!
        src.find(">dr[type]").each(function(){
          var obj=getObjByTypeOrCreate(res,$(this).attr("type"));
          obj.html(drSumm(obj.html(),$(this).html()))
        });
        $(res).find(">dr:first").html(drSumm($(res).find(">dr:first").text(),$(src).find(">dr:first").text()));

      }else{
        // если сумируем с объектом с листа
        var srcVal=(src.find("amount,>dr:first").not(".gc-source-value").text()||0);
        var addGlobal=true;

        src.find(">damage-type").each(function(){
          addGlobal=false;
          var k=1;
          if ($(src).attr("except-damage-type")=="yes") {
            addGlobal=true;
            k=-1;
          }
         var obj=getObjByTypeOrCreate(res,$(this).text());
         obj.html(drSumm(obj.html(),k*srcVal))
        });

        if (addGlobal) $(res).find(">dr").each(function(){
          $(this).html(drSumm($(this).html(),srcVal))
        });
      }
    }



    var locationsList=globalChar.find("locations-list");

    locationsList.find("location dr").remove();
    locationsList.find(".custom-location").remove();
    locationsList.find("location").prepend("<dr>0</dr>");
    locationsList.find("location[name='skull'] dr").html("2");

    var fullBody=$("<location><dr>0</dr></location>"); // Объект временного хранения
    var fullBodyExceptEyes=$("<location><dr>0</dr></location>"); // Объект временного хранения
    globalModifiersOn.find(">dr_bonus").each(function (){
      var location=$(this).find("location").text();
      var srcObj=$(this);
      if (location=='full body') {drSummObj(fullBody,srcObj);}
      else if (location=='full body except eyes') {drSummObj(fullBodyExceptEyes,srcObj);}
      else if (location=='head') {
        drSummObj(locationsList.find("location[name='face']"),srcObj);
        drSummObj(locationsList.find("location[name='skull']"),srcObj);
      }
      else {
        var obj = locationsList.find("location[name='" + location + "']");
        if (obj.length == 0) {
          var appendTo=locationsList;
          if (location=='chest'||location=='abdomen') appendTo=locationsList.find("location[name='torso']");
          if (location=='shoulders'||location=='upper arms'||location=='elbows'||location=='forearms') appendTo=locationsList.find("location[name='arms']");
          if (location=='thighs'||location=='knees'||location=='shins') appendTo=locationsList.find("location[name='legs']");
          obj = $("<location name='" + location + "' class='custom-location'><dr>0</dr></location>");
          appendTo.append(obj);
        }
        drSummObj(obj,srcObj);
      }
    });
    locationsList.find("location>location").each(function(){
      // суммируем сабброню
      drSummObj(this,$(this).parent())
    });

    locationsList.find("location").each(function(){
      drSummObj($(this),fullBody);
      if ($(this).attr("name")!="eyes") drSummObj($(this),fullBodyExceptEyes);
    });


    // Время расчета
    var calcTime = new Date().getTime() - calcStartTime;
    console.log('Calc time: ' + calcTime);

    globalCalced=true;

    $("body").lightStatus("low-speed-warning",(calcTime>globalCalcTimeLimit));


    undoSave();
    spellChartsMark();
  }


  var globalUndo,globalRedo,globalUndoLastSaved;

  function undoClear(){
    globalUndo = new SizeLimitedStack(undoLevel);
    globalRedo = new SizeLimitedStack(undoLevel);
    globalUndoLastSaved=false;
  }
  undoClear();

  function undoSave(){
    if (!(globalChar.html()===globalUndo.stack[globalUndo.length-1])){
      globalUndo.push(globalChar.html());
      globalUndoLastSaved=true;
      globalRedo = new SizeLimitedStack(undoLevel);
      $("#redoBtn").attr("disabled","true");
      if (globalUndo.length>1) $("#undoBtn").removeAttr("disabled");
    }
  }
  function undoRestore(){

    if (globalUndoLastSaved) {
      // снимаем текущее состояние из стэка

      globalUndo.pop();
      globalUndoLastSaved = false;
    }

    globalRedo.push(globalChar.html());
    globalChar.html(globalUndo.pop());
    undoRedoAfter();
  }

  function redoRestore(){
    globalUndo.push(globalChar.html());
    globalChar.html(globalRedo.pop());
    undoRedoAfter();
  }

  function undoRedoAfter(){
    if (globalUndo.length>0) $("#undoBtn").removeAttr("disabled"); else $("#undoBtn").attr("disabled","true");
    if (globalRedo.length>0) $("#redoBtn").removeAttr("disabled"); else $("#redoBtn").attr("disabled","true");

//    if (globalUndo.length==0) {$("#undoBtn").attr("disabled","true"); undoSave();}
    updateBrowserTitle();
    if (boardMode) {
      renderBoard(true);
    }
    else {
      globalChar.find("advantage,skill,technique,spell,equipment,advantage_container,skill_container,spell_container,equipment_container").each(function () {
        renderObj($(this));
      });

      setDrag();
      bindEvents();
    }

    saveButtonEnable();
  }





  function renderObj(obj){
    var tag = $(obj)[0].tagName.toLowerCase();
    if (tag == "advantage") renderAdvantage($(obj));
    if (tag == "skill"||tag == "technique") renderSkill($(obj));
    if (tag == "spell") renderSpell($(obj));
    if (tag == "equipment") renderEquipment($(obj));
    if (tag == "advantage_container"||tag == "skill_container"||tag == "spell_container"||tag == "equipment_container") renderContainer($(obj));


    $(obj).find("advantage_container,skill_container,spell_container,equipment_container").each(function (){renderContainer($(this));});
    $(obj).find("advantage").each(function (){renderAdvantage($(this));});
    $(obj).find("skill,technique").each(function (){renderSkill($(this));});
    $(obj).find("spell").each(function (){renderSpell($(this));});
    $(obj).find("equipment").each(function (){renderEquipment($(this));});
  }

  function editObj(obj,cancelDelete){
    var tag = $(obj)[0].tagName.toLowerCase();
    if (tag == "advantage") editAdvantage($(obj),cancelDelete);
    if (tag == "skill"||tag == "technique") editSkill($(obj),cancelDelete);
    if (tag == "spell") editSpell($(obj),cancelDelete);
    if (tag == "equipment") editEquipment($(obj),cancelDelete);
    if (tag == "advantage_container"||tag == "skill_container"||tag == "spell_container"||tag == "equipment_container") editContainer($(obj),cancelDelete);
  }



  if ($(window).width() > 800&&!gmMode&&!generatorMode) $("lib").addClass("visible") //показываем библиотеку на десктопе (на мобиле останется скрытой)

  function autoZoom(){
    zoomPage("reset");
    if ($(window).width() > 1600) zoomPage(1); // Автозум на больших разрешениях
    if ($(window).width() > 1300) zoomPage(1); // Автозум на больших разрешениях
  }
  autoZoom();

  function zoomPage(val) {
    var zoom = 0;
    if ($("body").hasClass("zoom-5")) zoom = -5;
    if ($("body").hasClass("zoom-4")) zoom = -4;
    if ($("body").hasClass("zoom-3")) zoom = -3;
    if ($("body").hasClass("zoom-2")) zoom = -2;
    if ($("body").hasClass("zoom-1")) zoom = -1;
    if ($("body").hasClass("zoom0")) zoom = 0;
    if ($("body").hasClass("zoom1")) zoom = 1;
    if ($("body").hasClass("zoom2")) zoom = 2;
    if ($("body").hasClass("zoom3")) zoom = 3;
    if ($("body").hasClass("zoom4")) zoom = 4;
    if ($("body").hasClass("zoom5")) zoom = 5;
    if ($("body").hasClass("zoom6")) zoom = 6;
    zoom = zoom + val;
    if (val=="reset") zoom=0;
    if (zoom > 6) zoom = 6;
    if (zoom < -5) zoom = -5;

    $("body").removeClass("zoom-5 zoom-4 zoom-3 zoom-2 zoom-1 zoom0 zoom1 zoom2 zoom3 zoom4 zoom5 zoom6");
    $("body").addClass("zoom" + zoom);
  }

  var profileObj = {};
  var profilePanelTimeout;
  function showProfilePanel() {
    clearTimeout(profilePanelTimeout);
    profileObj = $(this);
    if (profileObj[0].tagName=="NAME") $("profile-panel").addClass("restricted");
    else $("profile-panel").removeClass("restricted");

    $("profile-panel").css("top", $(this).offset().top);
    $("profile-panel").css("left", $(this).offset().left + $(this).width());
    $("profile-panel").show();
  }
  function hideProfilePanel(){
      $("profile-panel").hide();
    }
  function hideProfilePanelShedule() {
    clearTimeout(profilePanelTimeout);
    if ($("profile-panel").is(":visible")) {
      profilePanelTimeout = setTimeout(hideProfilePanel, 200);
    }
  }
  function profileSwap(obj,isLeft){
      var excludeList="name,portrait-img,sm,portrait,notes";
      if (isLeft) $(obj).prev().not(excludeList).before($(obj));
      else $(obj).next().not(excludeList).after($(obj));
      saveButtonEnable();
  }

  function profileItemAdd(obj) {
    var fieldsList = ['name','player_name','campaign', 'tech_level', 'title', 'age', 'birthday', 'eyes', 'hair', 'skin', 'handedness', 'height', 'weight', 'gender', 'race', 'religion'];
    var items="";
    fieldsList.forEach(function(item){
      if (globalChar.find("profile>"+item).length==0) items+="<line><label><input type='radio' name='addItem' value='"+item+"'/>Восстановить поле "+item+"</label></line>";
    });

    modalPopup("<h2>Добавить поле</h2><line><label><input type='radio' name='addItem' value='item' checked/>Добавить поле <input type='text' name=addItemName placeholder='название' autofocus style='margin:0;'></label></line>"+items, "Добавить", "Отмена", function () {

      var n=$("modalpopup input[name=addItem]:checked").val();
      var el = $("<"+n+" class='editable'></"+n+">");
      if (n=="item") el.attr("name",$("modalpopup input[name=addItemName]").val());
      $(obj).after(el);
      saveButtonEnable()
      bindEvents()
      el.focus();
    });
  }




  var spinnObj = {};
  var spinnPanelTimeout;
  function showSpinnPanel(obj) {
    clearTimeout(spinnPanelTimeout);
    spinnObj = $(obj);
    var left=$(obj).offset().left + $(obj).width();
    if (left>$(window).width()-40) {
      var tmp=$(obj).offset().left-40
      if (tmp>40) left=tmp;
      else {
        left=$(window).width()-40;
      }
    }
    $("spinn-panel").lightStatus("use-zoom",$(obj).parents("char-xml").length);

    $("spinn-panel").lightStatus("tool-btn",$(obj).hasClass("spinner-tool-btn"));

    $("spinn-panel").css("top", $(obj).offset().top);
    $("spinn-panel").css("left", left);
    $("spinn-panel").show();
  }
  function hideSpinnPanel() {
    $("spinn-panel").hide();
  }
  function hideSpinnPanelShedule() {
    clearTimeout(spinnPanelTimeout);
    if ($("spinn-panel").is(":visible")) {
      spinnPanelTimeout = setTimeout(hideSpinnPanel, 700);
    }
  }

  var floatPanelObj = {};
  var floatPanelTimeout;
  function showFloatPanel(obj, className) {
    clearTimeout(floatPanelTimeout);
    floatPanelObj = $(obj);
    className = className || "";
    className+=" tag_"+$(obj)[0].tagName.toLowerCase();
    $("float-panel").attr("class", className);
    $("float-panel").fadeIn(300);

    var top=event.y
    if (event.y + $("float-panel").height() > $("char").height()) {
      top=event.y - $("float-panel").height();
    }
    if (top<100) top=100;
    $("float-panel").css("top", top);
    $("float-panel").css("left", event.x);
    if (event.x + $("float-panel").width() > $("char").width()) {
      $("float-panel").css("left", event.x - 250);
    }



    if (isDropable($(window.localStorage.getItem('clipboard')||"<empty></empty>"),floatPanelObj)) {
      $("float-panel").find("past").removeClass('hide');
    } else {
      $("float-panel").find("past").addClass('hide');
    }

    moveItem(floatPanelObj,"prepare");
    event.stopPropagation();
  }

  function hideFloatPanel() {
    preventPanelScrollHide=false;
    $("float-panel").fadeOut(300);
  }
  function hideFloatPanelShedule() {
    clearTimeout(floatPanelTimeout);
    if ($("float-panel").is(":visible")) {
      floatPanelTimeout = setTimeout(hideFloatPanel, 700);
    }
  }
  $("float-panel").mouseleave(hideFloatPanelShedule).mouseenter(function () {
    clearTimeout(floatPanelTimeout);
  });

  $("char").scroll(function() {if (!preventPanelScrollHide) hideFloatPanel(); hideProfilePanel(); preventPanelScrollHide=false}).click(hideFloatPanel).scroll(hideSpinnPanel).click(hideSpinnPanelShedule());

  function cropPortraitDialog(src){
    var ratio=6/7;
    var realImageWidth=0;
    var realImageHeight=0;
    var containerWidth=0;
    var containerHeight=0;

    function doCrop(){
      var kW=realImageWidth/containerWidth;
      var kH=realImageHeight/containerHeight;

      var sourceX=$("modalpopup crop-tool").position().left*kW;
      var sourceY=$("modalpopup crop-tool").position().top*kH;
      var sourceWidth=$("modalpopup crop-tool").width()*kW;
      var sourceHeight=$("modalpopup crop-tool").height()*kH;
      var destX=0;
      var destY=0;
      var destWidth=600;
      var destHeight=700;



      var ctx=$("modalpopup canvas")[0].getContext('2d');
      $("modalpopup canvas")[0].width=destWidth;
      $("modalpopup canvas")[0].height=destHeight;
      ctx.drawImage( $("modalpopup img")[0], sourceX, sourceY, sourceWidth, sourceHeight, destX, destY, destWidth, destHeight);
    }



    modalPopup("<crop-area style='width:100%;'><crop-tool style='width:100%; height:100%; top:0; left:0;'></crop-tool><loading></loading><img style='display:none;'></crop-area><canvas style='display:none;'></canvas>","Сохранить","Отмена",function(){
      globalChar.find("portrait").html($("modalpopup canvas")[0].toDataURL().substr(22));
      portraitShow();
      undoSave();
      saveButtonEnable();
    },null,function () {
      $("modalpopup crop-tool")
        .resizable({stop:doCrop, aspectRatio:ratio,handles: "all", containment: "modalpopup crop-area"})
        .draggable({stop:doCrop, containment: "modalpopup crop-area"});
      $("modalpopup img").attr("src",src);
      $("modalpopup img").on("load", function () {
        $("modalpopup loading").hide();
        realImageWidth = $(this).width();
        realImageHeight = $(this).height();
        if (realImageWidth/realImageHeight>ratio) {$("modalpopup").addClass("wide");}
        $(this).css("width","100%").show();
        containerWidth=$("modalpopup img").width();
        containerHeight=$("modalpopup img").height();
        var containerRatio=containerWidth/containerHeight;
        if (containerRatio>6/7) {
          $("modalpopup crop-tool").css("height",containerHeight);
          $("modalpopup crop-tool").css("width",containerHeight*ratio);
          $("modalpopup crop-tool").css("top",0);
          $("modalpopup crop-tool").css("left",(containerWidth-(containerHeight*ratio))/2);
        }else {
          $("modalpopup crop-tool").css("width",containerWidth);
          $("modalpopup crop-tool").css("height",containerWidth/ratio);
          $("modalpopup crop-tool").css("left",0);
          $("modalpopup crop-tool").css("top",(containerHeight-(containerWidth/ratio))/2);
        }
        doCrop();
      })
      //$("modalpopup crop").draggable();

    });
  }


  function portraitPopup() {
    if (viewerMode) {
      modalPopup('<img style="max-width:100%;" src="data:image/png;base64,'+globalChar.find("portrait").html()+'"/>','ok');
      return
    };
    modalPopup('<form ID="upload_image"><h3>Сменить фото</h3>' +
      '<div style="text-align: left">' +
      '<label><input type="radio" name="upload" value="1" id="radio_file"/> Загрузить файл <input type="file" name="userfile" onClick="$(\'#radio_file\').prop(\'checked\', true);"></label><br><br>' +
      ((standaloneMode)?'':'<label><input type="radio" name="upload" value="2" id="radio_url"/> URL из сети <input type="text" name="upoad_url" size="38" onClick="$(\'#radio_url\').prop(\'checked\', true);"></label><br><br>') +
      '<label><input type="radio" name="upload" value="3"/> Удалить текущуюю картинку</label><br><br>' +
      '</div></form>'+
      (globalChar.find("portrait").html()!=""?'Текущая картинка<br/> <img style="max-width:100%;" src="data:image/png;base64,'+globalChar.find("portrait").html()+'"/>':''),
      'Ok', 'Cancel', function () {
        var selected=$("modalpopup input[name='upload']:checked").val();

        if (selected==1) {
          var src=URL.createObjectURL($("modalpopup input[name=userfile]")[0].files[0]);
          cropPortraitDialog(src);
          return false;
        }

        if (selected==2) {
          cropPortraitDialog("proxy-image.php?url="+encodeURIComponent($("modalpopup input[name=upoad_url]").val()));
          return false;
        }
        if (selected==3) {
          globalChar.find("portrait").html("");
          portraitShow();
          undoSave();
          saveButtonEnable();
        }
      });
  }

  function portraitShow() {
    if (globalChar.find("portrait").length)
    {
      var base = globalChar.find("portrait").html().replace(/(\r\n|\n|\r)/gm, "");
      globalChar.find("portrait-img").css("background-image", "url('data:image/png;base64," + base + "')"); //
    }
  }

  function showHistory() {
    $('body').addClass('show-history');
    historyScrollDown();
  }

  function showUserHistory(){
    $.ajax("publications-history.php?char="+currentChar).done(function (d){
      $("infopopup content").html(`<h3>История изменений</h3>
        <label><input type='checkbox' `+($("body").hasClass("show-changes-only")?'checked':'')+` onChange='$("body").lightStatus("show-changes-only",$(this).is(":checked"))'> Загружать только изменения</label>
        `+d);
      //$("infopopup").scrollTop(0).addClass("overLib");
      $("infopopup").removeClass("empty");
      $("infopopup").removeClass("hide");

    });
  }

  function showChangesOnly(){
      if (!viewerMode) return;
      globalChar.find(">notes,advantage,skill,technique,spell,equipment,advantage_container,skill_container,spell_container,equipment_container,advantage_list, skill_list, spell_list,equipment_list").hide();
      globalChar.find("*[moved=true],.moved,*[changed=true],.changed,*[deleted=true],.deleted").parentsUntil("char-xml").andSelf().show();
  }



  function editXML(obj, okCb, cancelCb) {

    if (viewerMode) return;

    var tagName = $(obj).prop("tagName");
    var clone = $(obj).clone();
    var containerCotent=clone.find(">advantage,>skill,>technique,>spell,>equipment,>advantage_container,>skill_container,>spell_container,>equipment_container").remove(); // Это для контейнеров
    var aceEditor;

    function xmlSimpleMode(){

      $("modalpopup .xml-tag-switcher").change();


      $("modalpopup button").removeClass("selected");
      $(".xml-simple-mode").addClass("selected");


      $("#ace-editor").hide();
      $("modalpopup object-edit").show();
      $(".xml-tag-switcher").show();

      $("modalpopup object-edit").html(aceEditor.getValue());



      initXmlEditor();

    }
    function xmlTextMode(){

      clearXmlObject()

      $("modalpopup button").removeClass("selected");
      $(".xml-text-mode").addClass("selected");

      $("#ace-editor").show();
      $("modalpopup object-edit").hide();
      $(".xml-tag-switcher").hide();

      aceEditor.setValue(formatHtml($("modalpopup object-edit").html()),-1);
    }

    clearObj(clone);

    modalPopup("<button class='secondary xml-simple-mode'>Упрощенный режим</button> <button class='secondary xml-text-mode'>Текстовый режим</button>"+
      "<xml-object>" +
      "<select class='xml-tag-switcher'><option value='1'>Тэги на англ.</option><option value='2'>Тэги рус. термины англ.</option><option value='3'>Все на рус.</option></select><object-edit></object-edit><div id='ace-editor'></div></xml-object>",
      "Ok", "Cancel",
      function () {
      var newObj={}
      if ($("modalpopup object-edit").is(":visible")) xmlTextMode(); //перейти в текстовый режим

      newObj=$(obj).replaceWithPush(aceEditor.getValue());

      // Возвращаем сожержимое контейнера

        $(newObj).append(containerCotent);

      clearObj($(newObj));

      renderObj($(newObj));

      setModifyAttr($(newObj),"changed");

      calcAll();
      setDrag();
      bindEvents();
      saveButtonEnable();
      if (okCb) okCb();
    }, function () {
      if (cancelCb) cancelCb();
    },function (){
      // initit
      $("modalpopup").addClass("wide");
        aceEditor= ace.edit("ace-editor");
        if ($.cookie("theme")=='dark') aceEditor.setTheme("ace/theme/twilight");
        else aceEditor.setTheme("ace/theme/eclipse");
        aceEditor.session.setMode("ace/mode/xml");
        aceEditor.session.setUseWrapMode(true);
        aceEditor.setShowPrintMargin(false);
        aceEditor.setFontSize(13);
        aceEditor.setValue($(clone).prop('outerHTML'),-1);

        $("modalpopup .xml-simple-mode").bind("click",xmlSimpleMode).click();
        $("modalpopup .xml-text-mode").bind("click",xmlTextMode);

        $("modalpopup .xml-tag-switcher").val($.cookie("xml-tag-switcher")||2);
        $("modalpopup .xml-tag-switcher").bind("change",function (){
          $("modalpopup").lightStatus('obj-names-rus',$(this).val()!=1)
          $("modalpopup").lightStatus('obj-names-short',$(this).val()==2)
          $.cookie("xml-tag-switcher",$(this).val(),{ expires: 10 * 365 });
        }).change();
      });
  }

  function convertContainerToEquipment(obj){
    var containerCotent=$(obj).find(">advantage,>skill,>technique,>spell,>equipment,>advantage_container,>skill_container,>spell_container,>equipment_container").remove(); // Это для контейнеров

    clearObj(obj);
    var newObj=$("<equipment version=\"3\" state=\""+$(obj).attr("state")+"\">"+$(obj).html()+"</equipment>");
    $(obj).before(newObj);
    $(obj).remove();
    $(newObj).find(">name").wrapInner("<description/>").children(0).unwrap(); // это просто правит старую ошибку

    $(newObj).after(containerCotent);


    renderObj($(newObj));
    checkEmptyContainers();
    calcAll();
    saveButtonEnable();

    return ($(newObj));
  }

  function convertEquipmentToContainer(obj){
    clearObj(obj);
    var newObj=$("<equipment_container open='no' state=\""+$(obj).attr("state")+"\">"+$(obj).html()+"</equipment_container>");
    $(obj).before(newObj);
    $(obj).remove();
    $(newObj).find("quantity").remove();

//    $(newObj).find("description").wrapInner("<name/>").children(0).unwrap();
    renderObj($(newObj));
    checkEmptyContainers();
    calcAll();
    saveButtonEnable();

    return ($(newObj));
  }


  function changeItem(obj) {
    var tag = $(obj)[0].tagName.toLowerCase();
    var res = false;

    if (tag == 'skill' || tag == 'technique') res = editSkill(obj, false);
    if (tag == 'spell') res = editSpell(obj, false);
    if (tag == 'advantage') res = editAdvantage(obj, false);
    if (tag == 'equipment') res = editEquipment(obj, false);
    if (tag == 'advantage_container') res = editContainer(obj, false);

    if (res == false) {
      flyAlert('У ' + $(obj).find(">name").text() + ' нет дополнительных настроек');
    }
  }

  function addNote(obj) {
    if ($(obj).find(">notes").length==0) {
       var app=$(obj).find(">gc-container-cost"); // Для контейнров надо ставить в другое место
       if (app.length==0) app=$(obj).find(">list-menu");
       app.after("<notes></notes>");
    }
    $(obj).find(">notes").addClass("editable").focus();
    bindEvents();
  }

  function advantageStopStart(obj){
    if ($(obj).attr("stopped")=="yes") $(obj).removeAttr("stopped");
    else $(obj).attr("stopped","yes");
    calcAll();
    saveButtonEnable();
  }
  function advantagesContainerStopStart(obj,doStart){
    var objs=$(obj).find("advantage");
    if (doStart) $(objs).removeAttr("stopped");
    else $(objs).attr("stopped","yes");
    calcAll();
    saveButtonEnable();

  }


  $("char").unbind("click").bind("click",function (){$("infopopup").addClass("overLib").addClass("empty");})
  $("lib").unbind("click").bind("click",function (){$("infopopup").removeClass("overLib").addClass("empty");})
  $("spell-charts").unbind("click").bind("click",function (){$("infopopup").addClass("overLib")})

  function viewHint(obj,force){
    var tag = obj[0].tagName;
    var resultText=$("constants hints>"+tag).html()||"";
    if (resultText=="") return;

    resultText=raplaceAllReferenceLink(resultText);

    resultText='<popup-description>'+resultText+'</popup-description>';
    $("infopopup content").html(resultText);
    $("infopopup").scrollTop(0).addClass("overLib");
    $("infopopup").removeClass("empty");
    if (force) $("infopopup").removeClass("hide");
  }

  function addPageBreak(obj){
    if ($(obj).attr("page-break")) $(obj).removeAttr("page-break");
    else $(obj).attr("page-break","true");
  }

  function duplicateItem(obj) {
    if (viewerMode) return;
    var newObj=$(obj).clone();
    $(newObj).find(".nosave").remove();
    $(obj).after(newObj);
    renderObj(newObj);

    setDrag();
    bindEvents();
    checkEmptyContainers();
    calcAll();
    saveButtonEnable();
    fieldChanged($(newObj));
    logIt($(newObj),"add");
  }

  function copyToStorage(obj) {
    var html="";
    $(obj).each(function(){html+=$(this)[0].outerHTML});
    window.localStorage.setItem('clipboard', html);
    flyAlert('Скопировано, можно вставлять на любом листе пресонажа',obj);
  }
  function pastFromStorage(inObj) {
    if (window.localStorage.getItem('clipboard')!==null){
      var obj=$(window.localStorage.getItem('clipboard'));
      clearObj(obj);
      if (isDropable(obj,inObj)){
        var tag = $(inObj)[0].tagName.toLowerCase();
        if (tag=="advantage_container"||tag=="skill_container"||tag=="spell_container"||tag=="equipment_container") {
          $(inObj).append(obj);
        } else {
          $(inObj).after(obj);
        }

        if (boardMode) {
          var left=Infinity,top=Infinity;
          $(obj).each(function(){
            left=Math.min(left,parseInt($(this).css('left')));
            top=Math.min(top,parseInt($(this).css('top')));
          });
          left=parseInt($(inObj).css('left'))+20-left;
          top=parseInt($(inObj).css('top'))+20-top;

          $(obj).css('left',"+="+left);
          $(obj).css('top',"+="+top);
          $(obj).removeAttr("id");
          $(obj).removeClass("selected");

          renderBoard();
          saveButtonEnable();
        }
        else {
          renderObj(obj);
          obj.addClass('ui-selected');

          checkEmptyContainers();
          setDrag();
          bindEvents();
          saveButtonEnable();
          calcAll();
          fieldChanged($(obj));
          logIt($(obj),"add");
        }
      }
      else {flyAlert('Объект '+obj[0].tagName+' нельзя вставить сюда',inObj);}
    }
  }

  var preventPanelScrollHide=false;
  function moveItem(obj,command) {
    if (viewerMode) return;

    preventPanelScrollHide=true;

    var horizontalSelector="advantage,skill,technique,spell,equipment,advantage_container,skill_container,spell_container,equipment_container";
    var verticalSelector="advantage_container,skill_container,spell_container,equipment_container";

    if (command=="prepare")
    {
      $("float-panel move-up").lightStatus("disabled",!($(obj).prev(horizontalSelector).length));
      $("float-panel move-down").lightStatus("disabled",!($(obj).next(horizontalSelector).length));
      $("float-panel move-left").lightStatus("disabled",!($(obj).parent(verticalSelector).length));
      $("float-panel move-right").lightStatus("disabled",!($(obj).next(verticalSelector).length));
      return;
    }

    if (command=="up")  $(obj).first().prev(horizontalSelector).before($(obj));
    if (command=="down") $(obj).last().next(horizontalSelector).after($(obj));
    if (command=="left") $(obj).first().parent(verticalSelector).before($(obj));
    if (command=="right") $(obj).last().next(verticalSelector).find(horizontalSelector).first().before($(obj));


    setModifyAttr(obj,'moved');

    checkEmptyContainers();

    selectElement($(obj),true);
    moveItem($(obj),"prepare");
    scrollObjOnCenter($(obj));

    calcAllSchedule();
    saveButtonEnable();


  }

  function deleteItem(obj) {
    if (viewerMode) return;
    logIt($(obj),"delete");
    if (publicLibMode) {
      setModifyAttr(obj,'deleted');
    }
    else {
      $(obj).remove();
    }

    checkEmptyContainers();
    calcAll();
    saveButtonEnable();
  }




  $("body").keydown(function (e) {

    if (e.key == 'Escape') {
      $("modalpopup .cancel").click();
      $("modalpopup .ok").click(); // Если у попапа сущестует только ОК давим на него
    }

    if (e.key == 'Enter' && !$(e.target).hasClass("editable")) {
      if (!$("modalpopup").length){
        $(".ui-selected").dblclick();
      }
    }

    if (e.key == 'Enter' && e.target.tagName != "TEXTAREA" && !$(e.target).hasClass("editable")) {
      $("modalpopup .ok").click(); // Если у попапа сущестует только ОК давим на него
    }

    //if ((e.key=='i'||e.key=='ш')&&!$(e.target).hasClass("editable")){
    if (e.key == 'F1') {
      //if ($(".ui-selected").length > 0) {viewDescription($(".ui-selected").first());}
      $("infopopup").toggleClass("hide");
      event.preventDefault()
    }
    if (e.key == 'F4' && !($(".ui-selected").parents("lib").length)) {
      if ($(".ui-selected").length > 0) {
        editXML($(".ui-selected").first());
      }
    }



    if ((e.key == "s" || e.key=="ы") && e.ctrlKey) {
      document.activeElement.blur()
      $("#saveBtn").click();
      event.preventDefault();
      return (false);
    }


    if (e.target.tagName == "BODY") {

      if (e.key == 'Delete' && !$(e.target).hasClass("editable")) {
        if (!$("modalpopup").length && $(".ui-selected").length && !($(".ui-selected").parents("lib").length)) {
          //var tag = $(".ui-selected").prop("tagName");
          var next = $(".ui-selected").next().first();
          deleteItem($(".ui-selected"));
          $(next).addClass("ui-selected");
        }
      }

      if ((e.keyCode == 90) && e.ctrlKey && !$(e.target).hasClass("editable")) { //ctrl Z, ctrl shift Z
        if (!$("modalpopup").length) {
          if (e.shiftKey) redoRestore();
          else undoRestore();
        }
      }

      var traversingTag = " skill,spell,advantage,technique,equipment,advantage_container,skill_container,spell_container,equipment_container";
      if (e.key == "ArrowDown" && !e.ctrlKey) {
        //var tag=$(".ui-selected").prop("tagName");
        if ($(".ui-selected").nextAll(traversingTag).not(".hide").length) {
          var newObj=$(".ui-selected").removeClass("ui-selected").nextAll(traversingTag).not(".hide").first().addClass("ui-selected");

          scrollObjOnCenter($(newObj));
          viewDescription($(newObj));
        }
      }
      if (e.key == "ArrowUp" && !e.ctrlKey) {
        //var tag=$(".ui-selected").prop("tagName");
        if ($(".ui-selected").prevAll(traversingTag).not(".hide").length) {
          var newObj=$(".ui-selected").removeClass("ui-selected").prevAll(traversingTag).not(".hide").first().addClass("ui-selected");

          scrollObjOnCenter($(newObj));
          viewDescription($(newObj));
        }
      }
      if (e.key == "ArrowUp" && e.ctrlKey) {moveItem(globalChar.find(".ui-selected"),"up")}
      if (e.key == "ArrowDown" && e.ctrlKey) {moveItem(globalChar.find(".ui-selected"),"down")}
      if (e.key == "ArrowLeft" && e.ctrlKey) {moveItem(globalChar.find(".ui-selected"),"left")}
      if (e.key == "ArrowRight" && e.ctrlKey) {moveItem(globalChar.find(".ui-selected"),"right")}

      if (e.key.length == 1 && !e.altKey && !e.ctrlKey && ($(".ui-selected").length > 0)) {

        if (Date.now() - quickSearchTimestamp > 1000) quickSearchText = ""; // Задержка на отчистку ввода 1 секунда
        quickSearchText = quickSearchText.concat(e.key);
        quickSearchTimestamp = Date.now();

        $(".ui-selected").parent().find(">*:not(.hide)>name,>*:not(.hide)>name-loc").each(function () {
          if ($(this).text().substring(0, quickSearchText.length).toLocaleLowerCase() == quickSearchText) {
            selectElement($(this).parent(), true);
            var block = $(this).parents(".scrollable-block");
            $(block).scrollTop($(block).scrollTop() + $(this).offset().top * 1 - $(block).height() / 2);
            return false;
          }
        });
      }


      if (gmMode&&e.ctrlKey&&e.keyCode>48&&e.keyCode<58){
        $($("gm-chars .my-char")[e.keyCode-49]).trigger("click");
        event.preventDefault();
      }

    }
  });
  var quickSearchText = ""; // global for quick searcing
  var quickSearchTimestamp = 0; // global for quick searcing


  var lastActiveTime=Date.now();
  $("body").on("mousemove keydown",function () {lastActiveTime=Date.now()});


  window.onbeforeunload = function () {
    if (!$("#saveBtn").prop('disabled')) return "Вы не сохранили изменения";
  }


  { // printing injections
    window.onbeforeprint = function() {
      setMentorTheme('light');
      var table=$("<table class='nosave ui-print-table-injection'><tr></tr></table>");
      $(table).find("tr").append(globalChar.find("advantage_list,skill_list").clone());
      globalChar.find("locations-list").after(table);
    }
    window.onafterprint = function() {
      setMentorTheme();
       $(".ui-print-table-injection").remove();
    }
  }

</script>
